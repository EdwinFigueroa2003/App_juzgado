{% extends "base.html" %}

{% block title %}Consultar Expedientes{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-search"></i> Consultar Expedientes
            </h2>

            <!-- Pesta침as de navegaci칩n -->
            <ul class="nav nav-tabs mb-4" id="expedienteTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="buscar-tab" data-bs-toggle="tab" href="#buscar" role="tab"
                        aria-controls="buscar" aria-selected="true">
                        <i class="fas fa-search"></i> Buscar por Radicado
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="filtrar-tab" data-bs-toggle="tab" href="#filtrar" role="tab"
                        aria-controls="filtrar" aria-selected="false">
                        <i class="fas fa-filter"></i> Filtrar por Estado
                    </a>
                </li>
            </ul>

            <!-- Contenido de las pesta침as -->
            <div class="tab-content" id="expedienteTabContent">

                <!-- PESTA칌A 1: Buscar por Radicado -->
                <div class="tab-pane fade show active" id="buscar" role="tabpanel" aria-labelledby="buscar-tab">
                    <!-- Formulario de b칰squeda por radicado -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Buscar por Radicado</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('idvistaexpediente.vista_expediente') }}">
                        <!-- 游 CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="tipo_busqueda" value="radicado">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="radicado">Radicado:</label>
                                            <input type="text" class="form-control" id="radicado" name="radicado"
                                                value="{{ radicado_buscar }}"
                                                placeholder="Ej: 08001418902020220003100" required>
                                            <small class="form-text text-muted">
                                                Puede buscar por radicado completo
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label>&nbsp;</label>
                                        <button type="submit" class="btn btn-primary btn-block">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- PESTA칌A 2: Filtrar por Estado -->
                <div class="tab-pane fade" id="filtrar" role="tabpanel" aria-labelledby="filtrar-tab">
                    <!-- Formulario de filtros -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Filtrar Expedientes por Estado</h5>
                        </div>
                        <div class="card-body filtros-expedientes">
                            <form method="POST" action="{{ url_for('idvistaexpediente.vista_expediente') }}">
                        <!-- 游 CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="tipo_busqueda" value="estado">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="estado_filtro" class="form-label">Estado del Expediente:</label>
                                            <select class="form-select form-select-lg" id="estado_filtro" name="estado_filtro"
                                                required>
                                                <option value="">Seleccione un estado</option>
                                                
                                                <!-- Estados Principales -->
                                                <optgroup label="Estados Principales">
                                                    <option value="ACTIVO" {{ 'selected' if estado_filtro=='ACTIVO' }}>
                                                        Activos <!-- (칰ltimos 6 meses) -->
                                                    </option>
                                                    <option value="INACTIVO" {{ 'selected' if estado_filtro=='INACTIVO' }}>
                                                        Inactivos <!-- (m치s de 6 meses) -->
                                                    </option>
                                                </optgroup>
                                                
                                                <!-- Estados Adicionales -->
                                                <optgroup label="Estados de Proceso">
                                                    <option value="PENDIENTE" {{ 'selected' if estado_filtro=='PENDIENTE' }}>
                                                        Pendientes (en despacho)
                                                    </option>
                                                    <option value="SALIO" {{ 'selected' if estado_filtro=='SALIO' }}>
                                                        Salieron (en secretar칤a)
                                                    </option>
                                                    <option value="SIN_FECHA" {{ 'selected' if estado_filtro=='SIN_FECHA' }}>
                                                        Sin Fecha (con radicado pero sin fechas)
                                                    </option>
                                                </optgroup>
                                                
                                                <!-- Combinaciones -->
                                                <optgroup label="Combinaciones">
                                                    <option value="ACTIVO_PENDIENTE" {{ 'selected' if estado_filtro=='ACTIVO_PENDIENTE' }}>
                                                        Activos + Pendientes
                                                    </option>
                                                    <option value="ACTIVO_SALIO" {{ 'selected' if estado_filtro=='ACTIVO_SALIO' }}>
                                                        Activos + Salieron
                                                    </option>
                                                    <option value="INACTIVO_PENDIENTE" {{ 'selected' if estado_filtro=='INACTIVO_PENDIENTE' }}>
                                                        Inactivos + Pendientes
                                                    </option>
                                                    <option value="INACTIVO_SALIO" {{ 'selected' if estado_filtro=='INACTIVO_SALIO' }}>
                                                        Inactivos + Salieron
                                                    </option>
                                                </optgroup>
                                                
                                                <!-- Estados Antiguos (Compatibilidad) -->
                                                <!-- <optgroup label="Estados Antiguos">
                                                    <option value="COMPLETADO" {{ 'selected' if estado_filtro=='COMPLETADO' }}>
                                                        Completado (antiguo)
                                                    </option>
                                                    <option value="EN_PROCESO" {{ 'selected' if estado_filtro=='EN_PROCESO' }}>
                                                        En Proceso (antiguo)
                                                    </option>
                                                    <option value="SIN_INFORMACION" {{ 'selected' if estado_filtro=='SIN_INFORMACION' }}>
                                                        Sin Informaci칩n (antiguo)
                                                    </option>
                                                </optgroup> -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="orden_fecha" class="form-label">Ordenar por Fecha:</label>
                                            <select class="form-select form-select-lg" id="orden_fecha" name="orden_fecha">
                                                <option value="DESC" {{ 'selected' if orden_fecha=='DESC' }}>M치s
                                                    reciente primero</option>
                                                <option value="ASC" {{ 'selected' if orden_fecha=='ASC' }}>M치s antiguo
                                                    primero</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="limite" class="form-label">Mostrar:</label>
                                            <select class="form-select form-select-lg" id="limite" name="limite">
                                                <option value="50" {{ 'selected' if limite=='50' }}>50</option>
                                                <option value="100" {{ 'selected' if limite=='100' }}>100</option>
                                                <option value="200" {{ 'selected' if limite=='200' }}>200</option>
                                                <option value="500" {{ 'selected' if limite=='500' }}>500</option>
                                                <option value="1000" {{ 'selected' if limite=='1000' }}>1000</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Filtros de fecha -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="fecha_desde" class="form-label">Fecha Desde:</label>
                                            <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" 
                                                   value="{{ fecha_desde or '' }}">
                                            <small class="form-text text-muted">Fecha m칤nima de ingreso/estado</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="fecha_hasta" class="form-label">Fecha Hasta:</label>
                                            <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" 
                                                   value="{{ fecha_hasta or '' }}">
                                            <small class="form-text text-muted">Fecha m치xima de ingreso/estado</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="tipo_fecha" class="form-label">Filtrar por:</label>
                                            <select class="form-select" id="tipo_fecha" name="tipo_fecha">
                                                <option value="ingreso" {{ 'selected' if tipo_fecha=='ingreso' }}>Fecha de Ingreso</option>
                                                <option value="estado" {{ 'selected' if tipo_fecha=='estado' }}>Fecha de Estado</option>
                                                <option value="ambas" {{ 'selected' if tipo_fecha=='ambas' }}>Cualquier Fecha</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-outline-secondary form-control" 
                                                    onclick="limpiarFiltrosFecha()">
                                                <i class="fas fa-eraser"></i> Limpiar Fechas
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Botones de fecha r치pida -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label class="form-label">Filtros r치pidos:</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-info btn-sm" 
                                                    onclick="establecerFechaRapida(7)">칔ltimos 7 d칤as</button>
                                            <button type="button" class="btn btn-outline-info btn-sm" 
                                                    onclick="establecerFechaRapida(30)">칔ltimo mes</button>
                                            <button type="button" class="btn btn-outline-info btn-sm" 
                                                    onclick="establecerFechaRapida(90)">칔ltimos 3 meses</button>
                                            <button type="button" class="btn btn-outline-info btn-sm" 
                                                    onclick="establecerFechaRapida(180)">칔ltimos 6 meses</button>
                                            <button type="button" class="btn btn-outline-info btn-sm" 
                                                    onclick="establecerFechaRapida(365)">칔ltimo a침o</button>
                                        </div>
                                    </div>
                                                <option value="1000" {{ 'selected' if limite=='1000' }}>1000</option>
                                                <option value="2000" {{ 'selected' if limite=='2000' }}>2000</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label>&nbsp;</label>
                                        <button type="submit" class="btn btn-success btn-block">
                                            <i class="fas fa-filter"></i> Filtrar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mensajes -->
            {% if mensaje %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> {{ mensaje }}
                {% if expedientes|length > 1 %}
                <br><small><strong>Nota:</strong> Se encontraron m칰ltiples expedientes con el mismo radicado corto. Esto
                    es normal cuando diferentes juzgados usan el mismo n칰mero.</small>
                {% endif %}
            </div>
            {% endif %}

            <!-- Resumen para m칰ltiples expedientes -->
            {% if resumen %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-list"></i> Resumen de Expedientes con Radicado: {{
                        resumen.radicado_buscado }}</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">{{ resumen.total_expedientes }}</h4>
                                <small>Expedientes</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">{{ resumen.total_ingresos }}</h4>
                                <small>Ingresos Totales</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">{{ resumen.total_estados }}</h4>
                                <small>Estados Totales</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="scrollToDetails()">
                                    <i class="fas fa-arrow-down"></i> Ver Detalles
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informaci칩n de paginaci칩n en resumen -->
                    {% if paginacion %}
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Paginaci칩n activada:</strong> Mostrando 10 expedientes por p치gina para mejorar el rendimiento.
                        Use los controles de navegaci칩n al final de los resultados.
                    </div>
                    {% endif %}

                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="thead-light">
                                <tr>
                                    <th>Radicado Completo</th>
                                    <th>Demandante</th>
                                    <th>Demandado</th>
                                    <th class="text-center">Ingresos</th>
                                    <th class="text-center">Estados</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for exp in resumen.expedientes_resumen %}
                                <tr>
                                    <td>{{ exp.radicado_completo or 'Sin radicado completo' }}</td>
                                    <td>{{ exp.demandante or 'No especificado' }}</td>
                                    <td>{{ exp.demandado or 'No especificado' }}</td>
                                    <td class="text-center"><span class="badge badge-success">{{ exp.ingresos }}</span>
                                    </td>
                                    <td class="text-center"><span class="badge badge-info">{{ exp.estados }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Resumen para filtros por estado -->
            {% if resumen_filtro %}
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar"></i>
                        Expedientes con Estado: {{ resumen_filtro.estado_filtrado }}
                        <span class="badge badge-light ml-2">{{ resumen_filtro.total_encontrados }} encontrados</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">{{ resumen_filtro.total_encontrados }}</h4>
                                <small>Expedientes</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">{{ resumen_filtro.orden }}</h4>
                                <small>Orden</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">{{ resumen_filtro.limite }}</h4>
                                <small>L칤mite Original</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="scrollToDetails()">
                                    <i class="fas fa-arrow-down"></i> Ver Resultados
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informaci칩n de paginaci칩n en resumen de filtros -->
                    {% if paginacion %}
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-info-circle"></i>
                        <strong>Paginaci칩n activada:</strong> Mostrando 10 expedientes por p치gina (p치gina {{ paginacion.pagina_actual }} de {{ paginacion.total_paginas }}).
                        Use los controles de navegaci칩n al final de los resultados.
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Resultados -->
            {% if expedientes %}
            <div class="row" id="resultados-expedientes">
                {% for expediente in expedientes %}
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-folder"></i>
                                Expediente: {{ expediente.radicado_completo or expediente.radicado_corto }}
                                {% if expedientes|length > 1 %}
                                <small class="badge badge-light ml-2">{{ loop.index }} de {{ expedientes|length }}</small>
                                {% endif %}
                                <span class="badge badge-warning ml-2">
                                    {% if expediente.estado_principal and expediente.estado_adicional %}
                                        {{ expediente.estado_principal }} + {{ expediente.estado_adicional }}
                                    {% elif expediente.estado_principal %}
                                        {{ expediente.estado_principal }}
                                    {% elif expediente.estado_adicional %}
                                        {{ expediente.estado_adicional }}
                                    {% else %}
                                        {{ expediente.estado_actual or 'Sin estado' }}
                                    {% endif %}
                                </span>
                            </h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-light" 
                                        onclick="copiarRadicado('{{ expediente.radicado_completo or expediente.radicado_corto }}')"
                                        title="Copiar radicado">
                                    <i class="fas fa-copy"></i>
                                </button>
                                {% if resumen_filtro %}
                                <!-- Vista de filtro por estado: solo bot칩n Ver m치s -->
                                <button type="button" class="btn btn-sm btn-outline-light" 
                                        onclick="toggleExpedienteDetails('{{ expediente.id }}')"
                                        title="Ver detalles completos">
                                    <i class="fas fa-eye"></i> Ver m치s
                                </button>
                                {% endif %}
                                <a href="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}?radicado={{ expediente.radicado_completo or expediente.radicado_corto }}" 
                                   class="btn btn-sm btn-warning" title="Editar este expediente">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                            </div>
                        </div>
                        
                        {% if resumen_filtro %}
                        <!-- Vista compacta para filtros por estado -->
                        <div class="card-body expediente-details expediente-details-hidden" data-expediente-id="{{ expediente.id }}">
                        {% else %}
                        <!-- Vista completa para b칰squeda por radicado -->
                        <div class="card-body" data-expediente-id="{{ expediente.id }}">
                        {% endif %}
                            <!-- Informaci칩n b치sica del expediente -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6><strong><i class="fas fa-info-circle"></i> Informaci칩n General</strong></h6>
                                    <p><strong>Radicado Completo:</strong> {{ expediente.radicado_completo or 'No disponible' }}</p>
                                    <p><strong>Radicado Corto:</strong> {{ expediente.radicado_corto or 'No disponible' }}</p>
                                    <p><strong>Estado Actual:</strong>
                                        {% if expediente.estado_principal and expediente.estado_adicional %}
                                            <span class="badge badge-success">{{ expediente.estado_principal }}</span>
                                            <span class="badge badge-info">{{ expediente.estado_adicional }}</span>
                                        {% elif expediente.estado_principal %}
                                            <span class="badge badge-success">{{ expediente.estado_principal }}</span>
                                        {% elif expediente.estado_adicional %}
                                            <span class="badge badge-info">{{ expediente.estado_adicional }}</span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ expediente.estado_actual or 'Sin estado' }}</span>
                                        {% endif %}
                                    </p>
                                    <!-- <p><strong>Ubicaci칩n:</strong> {{ expediente.ubicacion_actual or 'No especificada' }}</p> -->
                                    <p><strong>Responsable:</strong> 
                                        {% if expediente.responsable %}
                                            <span class="badge badge-success">{{ expediente.responsable }}</span>
                                        {% else %}
                                            <span class="badge badge-secondary">No asignado</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <h6><strong><i class="fas fa-users"></i> Partes del Proceso</strong></h6>
                                    <p><strong>Demandante:</strong> {{ expediente.demandante or 'No especificado' }}</p>
                                    <p><strong>Demandado:</strong> {{ expediente.demandado or 'No especificado' }}</p>
                                    <p><strong>Tipo de Tr치mite:</strong> {{ expediente.tipo_tramite or 'No especificado' }}</p>
                                    <p><strong>Juzgado de Origen:</strong> {{ expediente.juzgado_origen or 'No especificado' }}</p>
                                    {% if expediente.fecha_resolucion %}
                                    <p><strong>Fecha de Resoluci칩n:</strong> {{ expediente.fecha_resolucion.strftime('%d/%m/%Y') }}</p>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Fechas importantes -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6><strong><i class="fas fa-calendar"></i> Fechas Importantes</strong></h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <small class="text-muted">Fecha de Creaci칩n/Ingreso:</small><br>
                                            <strong>{{ expediente.fecha_creacion_registro.strftime('%d/%m/%Y %H:%M') if expediente.fecha_creacion_registro else 'No disponible' }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">칔ltima Actualizaci칩n Sistema:</small><br>
                                            <strong>{{ expediente.fecha_ultima_actualizacion.strftime('%d/%m/%Y %H:%M') if expediente.fecha_ultima_actualizacion else 'No disponible' }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">칔ltima Actuaci칩n Real:</small><br>
                                            <strong>{{ expediente.fecha_ultima_actuacion_real.strftime('%d/%m/%Y') if expediente.fecha_ultima_actuacion_real else 'No disponible' }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Total de Tr치mites:</small><br>
                                            <strong>{{ expediente.total_tramites or 0 }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Estad칤sticas del expediente -->
                            {% if expediente.estadisticas %}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6><strong><i class="fas fa-chart-pie"></i> Estad칤sticas de Tr치mites</strong></h6>
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="text-center p-2 bg-light rounded">
                                                <h4 class="text-primary mb-0">{{ expediente.estadisticas.total_tramites_detalle or 0 }}</h4>
                                                <small>Total</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center p-2 bg-light rounded">
                                                <h4 class="text-success mb-0">{{ expediente.estadisticas.tramites_finalizados or 0 }}</h4>
                                                <small>Finalizados</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center p-2 bg-light rounded">
                                                <h4 class="text-warning mb-0">{{ expediente.estadisticas.tramites_pendientes or 0 }}</h4>
                                                <small>Pendientes</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center p-2 bg-light rounded">
                                                <h4 class="text-secondary mb-0">{{ expediente.estadisticas.tramites_sin_tramite or 0 }}</h4>
                                                <small>Sin Tr치mite</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center p-2 bg-light rounded">
                                                {% set total = expediente.estadisticas.total_tramites_detalle or 0 %}
                                                {% set finalizados = expediente.estadisticas.tramites_finalizados or 0 %}
                                                {% if total > 0 %}
                                                    <h4 class="text-info mb-0">{{ "%.1f"|format((finalizados / total) * 100) }}%</h4>
                                                {% else %}
                                                    <h4 class="text-info mb-0">0%</h4>
                                                {% endif %}
                                                <small>Porcentaje Completado</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Ingresos del expediente -->
                            {% if expediente.ingresos %}
                            <div class="mb-3">
                                <h6><strong><i class="fas fa-calendar-plus"></i> Historial de Ingresos ({{
                                        expediente.ingresos|length }})</strong></h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Solicitud</th>
                                                <th>Observaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ingreso in expediente.ingresos %}
                                            <tr>
                                                <td>{{ ingreso.fecha_ingreso.strftime('%d/%m/%Y') if
                                                    ingreso.fecha_ingreso else 'No disponible' }}</td>
                                                <td>{{ ingreso.motivo_ingreso or 'Sin motivo' }}</td>
                                                <td>
                                                    {% if ingreso.observaciones_ingreso %}
                                                        {% set obs_text = ingreso.observaciones_ingreso %}
                                                        {% if obs_text|length > 100 %}
                                                            <div class="observaciones-ingreso-container">
                                                                <small class="observaciones-ingreso-preview">{{ obs_text[:100] }}...</small>
                                                                <div class="observaciones-ingreso-full" style="display: none;">
                                                                    <small>{{ obs_text }}</small>
                                                                </div>
                                                                <br>
                                                                <button type="button" class="btn btn-sm btn-outline-primary btn-toggle-observaciones-ingreso" 
                                                                        onclick="toggleObservacionesIngresoText(this)">
                                                                    <i class="fas fa-expand"></i> Ver completo
                                                                </button>
                                                            </div>
                                                        {% else %}
                                                            <small>{{ obs_text }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">Sin observaciones</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Estados del expediente -->
                            {% if expediente.estados %}
                            <div class="mb-3">
                                <h6><strong><i class="fas fa-history"></i> Historial de Estados ({{
                                        expediente.estados|length }})</strong></h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Estado</th>
                                                <th>Observaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for estado in expediente.estados %}
                                            <tr>
                                                <td>{{ estado.fecha_estado.strftime('%d/%m/%Y') if estado.fecha_estado
                                                    else 'No disponible' }}</td>
                                                <td>
                                                    <span class="badge badge-secondary">{{ estado.estado_registrado or
                                                        'Sin estado' }}</span>
                                                </td>
                                                <td>{{ estado.observaciones_estado or 'Sin observaciones' }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Tr치mites detallados -->
                            {% if expediente.tramites_detallados %}
                            <div class="mb-3">
                                <h6><strong><i class="fas fa-list-alt"></i> Tr치mites Detallados ({{ expediente.tramites_detallados|length }}{% if expediente.estadisticas.total_tramites_detalle > expediente.tramites_detallados|length %} de {{ expediente.estadisticas.total_tramites_detalle }}{% endif %})</strong></h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Fecha Actuaci칩n</th>
                                                <th>Estado Tr치mite</th>
                                                <th>Tipo Tr치mite</th>
                                                <th>Fecha Notificaci칩n</th>
                                                <th>Auto/Resoluci칩n</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for tramite in expediente.tramites_detallados %}
                                            <tr>
                                                <td>{{ tramite.fecha_actuacion.strftime('%d/%m/%Y') if tramite.fecha_actuacion else 'No disponible' }}</td>
                                                <td>
                                                    {% if tramite.estado_tramite %}
                                                        {% if 'FINALIZADO' in tramite.estado_tramite.upper() or 'COMPLETADO' in tramite.estado_tramite.upper() %}
                                                            <span class="badge badge-success">{{ tramite.estado_tramite }}</span>
                                                        {% elif 'PENDIENTE' in tramite.estado_tramite.upper() or 'PROCESO' in tramite.estado_tramite.upper() %}
                                                            <span class="badge badge-warning">{{ tramite.estado_tramite }}</span>
                                                        {% else %}
                                                            <span class="badge badge-secondary">{{ tramite.estado_tramite }}</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">Sin estado</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ tramite.tramite_homologado or 'No especificado' }}</td>
                                                <td>{{ tramite.fecha_estado_notificacion.strftime('%d/%m/%Y') if tramite.fecha_estado_notificacion else 'No disponible' }}</td>
                                                <td>
                                                    {% if tramite.auto %}
                                                        {% set auto_text = tramite.auto %}
                                                        {% if auto_text|length > 100 %}
                                                            <div class="auto-text-container">
                                                                <small class="auto-preview">{{ auto_text[:100] }}...</small>
                                                                <div class="auto-full" style="display: none;">
                                                                    <small>{{ auto_text }}</small>
                                                                </div>
                                                                <br>
                                                                <button type="button" class="btn btn-sm btn-outline-primary btn-toggle-auto" 
                                                                        onclick="toggleAutoText(this)">
                                                                    <i class="fas fa-expand"></i> Ver completo
                                                                </button>
                                                            </div>
                                                        {% else %}
                                                            <small>{{ auto_text }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">Sin auto</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% if expediente.estadisticas.total_tramites_detalle > expediente.tramites_detallados|length %}
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Mostrando los {{ expediente.tramites_detallados|length }} tr치mites m치s recientes de {{ expediente.estadisticas.total_tramites_detalle }} totales.
                                </small>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Observaciones adicionales -->
                            {% if expediente.observaciones %}
                            <div class="mb-3">
                                <h6><strong><i class="fas fa-sticky-note"></i> Observaciones Adicionales</strong></h6>
                                <div class="alert alert-light">
                                    <small>{{ expediente.observaciones }}</small>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Informaci칩n adicional -->
                            <div class="row mt-3 pt-3 border-top">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i>
                                        <strong>칔ltima actualizaci칩n:</strong> {{ expediente.fecha_ultima_actualizacion.strftime('%d/%m/%Y %H:%M') if expediente.fecha_ultima_actualizacion else 'No disponible' }}
                                    </small>
                                </div>
                                <div class="col-md-6 text-right">
                                    <small class="text-muted">
                                        <i class="fas fa-database"></i>
                                        <strong>ID del expediente:</strong> {{ expediente.id }}
                                    </small>
                                </div>
                            </div>

                            <!-- Resumen r치pido -->
                            <div class="row mt-2">
                                <div class="col-12">
                                    <div class="alert alert-info alert-sm">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Resumen:</strong>
                                        {{ expediente.ingresos|length }} ingreso(s), 
                                        {{ expediente.estados|length }} estado(s) registrado(s){% if expediente.tramites_detallados %}, 
                                        {{ expediente.tramites_detallados|length }} tr치mite(s) detallado(s){% endif %}
                                        {% if expediente.estadisticas.total_tramites_detalle %}
                                        - Total de {{ expediente.estadisticas.total_tramites_detalle }} tr치mite(s) en el sistema
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Paginaci칩n -->
            {% if paginacion and paginacion.total_paginas > 1 %}
            <div class="row mt-4">
                <div class="col-12">
                    <nav aria-label="Paginaci칩n de expedientes">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <small class="text-muted">
                                    Mostrando {{ paginacion.inicio_item }} - {{ paginacion.fin_item }} de {{ paginacion.total_items }} expedientes
                                </small>
                            </div>
                            <div>
                                <small class="text-muted">
                                    P치gina {{ paginacion.pagina_actual }} de {{ paginacion.total_paginas }}
                                </small>
                            </div>
                        </div>
                        
                        <ul class="pagination justify-content-center">
                            <!-- Bot칩n Anterior -->
                            <li class="page-item {{ 'disabled' if not paginacion.tiene_anterior }}">
                                {% if paginacion.tiene_anterior %}
                                    <a class="page-link" href="{{ url_for('idvistaexpediente.vista_expediente') }}?pagina={{ paginacion.pagina_anterior }}{% if paginacion.tipo_busqueda == 'radicado' %}&radicado={{ paginacion.radicado }}{% elif paginacion.tipo_busqueda == 'estado' %}&estado={{ paginacion.estado }}&orden={{ paginacion.orden }}&limite={{ paginacion.limite }}{% endif %}" aria-label="Anterior">
                                        <span aria-hidden="true">&laquo; Anterior</span>
                                    </a>
                                {% else %}
                                    <span class="page-link">&laquo; Anterior</span>
                                {% endif %}
                            </li>
                            
                            <!-- N칰meros de p치gina -->
                            {% for num_pagina in paginacion.paginas_mostrar %}
                                <li class="page-item {{ 'active' if num_pagina == paginacion.pagina_actual }}">
                                    {% if num_pagina == paginacion.pagina_actual %}
                                        <span class="page-link">{{ num_pagina }}</span>
                                    {% else %}
                                        <a class="page-link" href="{{ url_for('idvistaexpediente.vista_expediente') }}?pagina={{ num_pagina }}{% if paginacion.tipo_busqueda == 'radicado' %}&radicado={{ paginacion.radicado }}{% elif paginacion.tipo_busqueda == 'estado' %}&estado={{ paginacion.estado }}&orden={{ paginacion.orden }}&limite={{ paginacion.limite }}{% endif %}">{{ num_pagina }}</a>
                                    {% endif %}
                                </li>
                            {% endfor %}
                            
                            <!-- Bot칩n Siguiente -->
                            <li class="page-item {{ 'disabled' if not paginacion.tiene_siguiente }}">
                                {% if paginacion.tiene_siguiente %}
                                    <a class="page-link" href="{{ url_for('idvistaexpediente.vista_expediente') }}?pagina={{ paginacion.pagina_siguiente }}{% if paginacion.tipo_busqueda == 'radicado' %}&radicado={{ paginacion.radicado }}{% elif paginacion.tipo_busqueda == 'estado' %}&estado={{ paginacion.estado }}&orden={{ paginacion.orden }}&limite={{ paginacion.limite }}{% endif %}" aria-label="Siguiente">
                                        <span aria-hidden="true">Siguiente &raquo;</span>
                                    </a>
                                {% else %}
                                    <span class="page-link">Siguiente &raquo;</span>
                                {% endif %}
                            </li>
                        </ul>
                        
                        <!-- Navegaci칩n r치pida -->
                        {% if paginacion.total_paginas > 10 %}
                        <div class="text-center mt-3">
                            <div class="btn-group" role="group" aria-label="Navegaci칩n r치pida">
                                {% if paginacion.pagina_actual > 5 %}
                                    <a href="{{ url_for('idvistaexpediente.vista_expediente') }}?pagina=1{% if paginacion.tipo_busqueda == 'radicado' %}&radicado={{ paginacion.radicado }}{% elif paginacion.tipo_busqueda == 'estado' %}&estado={{ paginacion.estado }}&orden={{ paginacion.orden }}&limite={{ paginacion.limite }}{% endif %}" 
                                       class="btn btn-sm btn-outline-primary">Primera</a>
                                {% endif %}
                                
                                {% if paginacion.pagina_actual < paginacion.total_paginas - 4 %}
                                    <a href="{{ url_for('idvistaexpediente.vista_expediente') }}?pagina={{ paginacion.total_paginas }}{% if paginacion.tipo_busqueda == 'radicado' %}&radicado={{ paginacion.radicado }}{% elif paginacion.tipo_busqueda == 'estado' %}&estado={{ paginacion.estado }}&orden={{ paginacion.orden }}&limite={{ paginacion.limite }}{% endif %}" 
                                       class="btn btn-sm btn-outline-primary">칔ltima</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </nav>
                </div>
            </div>
            {% endif %}
            {% elif radicado_buscar or estado_filtro %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                {% if radicado_buscar %}
                No se encontraron expedientes con el radicado: <strong>{{ radicado_buscar }}</strong>
                {% elif estado_filtro %}
                No se encontraron expedientes con el estado: <strong>{{ estado_filtro }}</strong>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Indicador para JavaScript si se debe activar la pesta침a de filtros -->
{% if estado_filtro %}
<div data-activar-filtros="true" style="display: none;"></div>
{% endif %}

<!-- JavaScript consolidado en base.js -->

<script>
function limpiarFiltrosFecha() {
    document.getElementById('fecha_desde').value = '';
    document.getElementById('fecha_hasta').value = '';
    document.getElementById('tipo_fecha').value = 'ingreso';
}

// Funci칩n para establecer fechas r치pidas
function establecerFechaRapida(dias) {
    const hoy = new Date();
    const fechaHasta = hoy.toISOString().split('T')[0];
    
    const fechaDesde = new Date();
    fechaDesde.setDate(hoy.getDate() - dias);
    const fechaDesdeStr = fechaDesde.toISOString().split('T')[0];
    
    document.getElementById('fecha_desde').value = fechaDesdeStr;
    document.getElementById('fecha_hasta').value = fechaHasta;
}
</script>

{% endblock %}