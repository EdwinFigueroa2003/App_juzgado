{% extends "base.html" %}

{% block title %}Subir Expedientes{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-upload"></i> Subir Expedientes
            </h2>
            
            <!-- Mensajes de flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' if category == 'info' else 'warning' }} alert-dismissible fade show"
                role="alert">
                <i
                    class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }}">
                </i>
                {{ message|safe }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <!-- Informaci칩n sobre roles -->
            <div class="alert alert-info mb-4" style="margin-top: 2%;">
                <h6><i class="fas fa-info-circle"></i> Informaci칩n sobre Asignaci칩n por Roles</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong><i class="fas fa-pen text-success"></i> ESCRIBIENTE:</strong>
                        <small class="text-muted d-block">Encargado de redacci칩n, documentaci칩n y actualizaci칩n de
                            expedientes</small>
                    </div>
                    <div class="col-md-6">
                        <strong><i class="fas fa-gavel text-info"></i> SUSTANCIADOR:</strong>
                        <small class="text-muted d-block">Encargado de revisi칩n, an치lisis y sustanciaci칩n de
                            casos</small>
                    </div>
                </div>
                <hr class="my-2">
                <small class="text-muted">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Ventaja:</strong> Al asignar por rol, cualquier usuario con ese rol puede trabajar el
                    expediente,
                    proporcionando mayor flexibilidad en la gesti칩n de casos.
                </small>
            </div>
            
            <!-- Bot칩n para ver reportes de errores -->
            <div class="mb-4 text-center">
                <button type="button" class="btn btn-warning btn-lg" onclick="abrirModalReportes()">
                    <i class="fas fa-file-download"></i> Descargar Reportes de Errores
                </button>
            </div>

            <!-- Pesta침as simples -->
            <div class="tab">
                <button class="tablinks" onclick="openTab(event, 'Manual')">
                    <i class="fas fa-edit"></i> Ingreso Manual
                </button>
                <button class="tablinks" onclick="openTab(event, 'Excel')">
                    <i class="fas fa-file-excel"></i> Subir desde Excel Nuevos
                </button>
                <button class="tablinks" onclick="openTab(event, 'Excel_actualizacion')">
                    <i class="fas fa-file-excel"></i> Subir desde Excel Actualizaciones
                </button>
            </div>

            <!-- Contenido: Ingreso Manual -->
            <div id="Manual" class="tabcontent">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-edit"></i> Ingreso Manual de Expediente
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-4">Ingresa un expediente individual completando el formulario:</p>

                        <form method="POST" action="{{ url_for('idvistasubirexpediente.vista_subirexpediente') }}">
                            <!-- 游 CSRF Protection -->
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div class="form-group">
                                <label for="radicado_completo">Radicado Completo:</label>
                                <input type="text" class="form-control" id="radicado_completo" name="radicado_completo"
                                    placeholder="Ej: 08001418902020220003100" pattern="[0-9]{23}"
                                    title="El radicado completo debe tener exactamente 23 d칤gitos" maxlength="23">
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Debe contener exactamente 23 d칤gitos num칠ricos
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="radicado_corto">Radicado Corto:</label>
                                <input type="text" class="form-control" id="radicado_corto" name="radicado_corto"
                                    placeholder="Ej: 2022-00031">
                            </div>

                            <div class="form-group">
                                <label for="demandante">Demandante:</label>
                                <input type="text" class="form-control" id="demandante" name="demandante"
                                    placeholder="Nombre del demandante">
                            </div>

                            <div class="form-group">
                                <label for="demandado">Demandado:</label>
                                <input type="text" class="form-control" id="demandado" name="demandado"
                                    placeholder="Nombre del demandado">
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="estado_actual">Estado Actual:</label>
                                        <select class="form-control" id="estado_actual" name="estado_actual">
                                            <option value="">Seleccionar estado</option>
                                            <option value="Pendiente">Pendiente</option>
                                            <option value="Activo Pendiente">Activo Pendiente</option>
                                            <option value="Inactivo Resuelto">Inactivo Resuelto</option>
                                            <option value="Activo Resuelto">Activo Resuelto</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="ubicacion">Ubicaci칩n:</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="ubicacion" 
                                               name="ubicacion"
                                               placeholder="Ubicaci칩n del expediente">
                                    </div>
                                </div> -->
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="tipo_solicitud">Tipo de Solicitud:</label>
                                        <input type="text" class="form-control" id="tipo_solicitud"
                                            name="tipo_solicitud" placeholder="Tipo de solicitud">
                                    </div>
                                </div>
                                <!-- <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="juzgado_origen">Juzgado de Origen:</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="juzgado_origen" 
                                               name="juzgado_origen"
                                               placeholder="Juzgado de origen">
                                    </div>
                                </div> -->
                            </div>

                            <div class="form-group">
                                <label for="responsable">Responsable (Rol):</label>
                                <select class="form-control" id="responsable" name="responsable">
                                    <option value="">Seleccionar rol</option>
                                    {% for rol in roles %}
                                    <option value="{{ rol.nombre_rol }}">
                                        {% if rol.nombre_rol == 'ESCRIBIENTE' %}
                                        <i class="fas fa-pen"></i> {{ rol.nombre_rol }}
                                        {% elif rol.nombre_rol == 'SUSTANCIADOR' %}
                                        <i class="fas fa-gavel"></i> {{ rol.nombre_rol }}
                                        {% else %}
                                        {{ rol.nombre_rol }}
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Asignar por rol permite que cualquier usuario con ese rol pueda trabajar el
                                    expediente
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="observaciones">Observaciones:</label>
                                <textarea class="form-control" id="observaciones" name="observaciones" rows="2"
                                    placeholder="Observaciones generales del expediente"></textarea>
                            </div>

                            <!-- Secci칩n de Ingreso -->
                            <hr>
                            <h6 class="text-primary"><i class="fas fa-calendar-plus"></i> Informaci칩n de Ingreso</h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="fecha_ingreso">Fecha de Ingreso:</label>
                                        <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso">
                                        <small class="form-text text-muted">Si no se especifica, se usar치 la fecha
                                            actual</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="motivo_ingreso">Motivo/Solicitud:</label>
                                        <input type="text" class="form-control" id="motivo_ingreso"
                                            name="motivo_ingreso" placeholder="Motivo del ingreso o solicitud">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="observaciones_ingreso">Observaciones del Ingreso:</label>
                                <textarea class="form-control" id="observaciones_ingreso" name="observaciones_ingreso"
                                    rows="2" placeholder="Observaciones espec칤ficas del ingreso"></textarea>
                            </div>

                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Guardar Expediente
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Contenido: Subir desde Excel Nuevos -->
            <div id="Excel" class="tabcontent">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-excel"></i> Subir Expedientes Nuevos desde Excel
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-4">Sube un archivo Excel con m칰ltiples expedientes
                            <strong>NUEVOS</strong>. El sistema detectar치 autom치ticamente la hoja m치s apropiada y las
                            columnas disponibles:</p>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="fas fa-list"></i> Formato Tradicional - Columnas
                                    Requeridas:</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item"><strong>RADICADO COMPLETO</strong></li>
                                    <li class="list-group-item"><strong>DEMANDANTE</strong></li>
                                    <li class="list-group-item"><strong>DEMANDADO</strong></li>
                                    <li class="list-group-item"><strong>FECHA INGRESO</strong></li>
                                    <li class="list-group-item"><strong>SOLICITUD</strong></li>
                                </ul>
                            </div>

                            <div class="col-md-6">
                                <h6 class="text-secondary"><i class="fas fa-list"></i> Columnas Opcionales:</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">RADICADO CORTO</li>
                                    <li class="list-group-item">ESTADO</li>
                                    <li class="list-group-item">UBICACION</li>
                                    <li class="list-group-item">J. ORIGEN</li>
                                    <li class="list-group-item">JUZGADO ORIGEN</li>
                                    <li class="list-group-item">RESPONSABLE <small class="text-muted">(usar: ESCRIBIENTE
                                            o SUSTANCIADOR)</small></li>
                                    <li class="list-group-item">OBSERVACIONES</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Nueva secci칩n para m칰ltiples pesta침as -->
                        <div class="alert alert-success mb-4">
                            <h6 class="text-success"><i class="fas fa-layer-group"></i> Nuevo: Formato con M칰ltiples
                                Pesta침as</h6>
                            <p class="mb-2">Ahora puedes subir archivos Excel con m칰ltiples pesta침as para organizar
                                mejor tu informaci칩n:</p>

                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-success"><i class="fas fa-inbox"></i> Pesta침a "ingreso":</h6>
                                    <ul class="small mb-2">
                                        <li><strong>RADICADO COMPLETO</strong> (requerido)</li>
                                        <li><strong>DEMANDANTE</strong> (requerido)</li>
                                        <li><strong>DEMANDADO</strong> (requerido)</li>
                                        <li><strong>FECHA INGRESO</strong> (requerido)</li>
                                        <li><strong>SOLICITUD</strong> (requerido)</li>
                                        <li>ESTADO, RESPONSABLE, UBICACION (opcionales)</li>
                                    </ul>
                                </div>

                                <div class="col-md-6">
                                    <h6 class="text-success"><i class="fas fa-clipboard-list"></i> Pesta침a "estados":
                                    </h6>
                                    <ul class="small mb-2">
                                        <li><strong>RADICADO COMPLETO</strong> (requerido)</li>
                                        <li><strong>CLASE</strong> (requerido)</li>
                                        <li><strong>DEMANDANTE</strong> (requerido)</li>
                                        <li><strong>DEMANDADO</strong> (requerido)</li>
                                        <li><strong>FECHA ESTADO</strong> (requerido)</li>
                                        <li><strong>AUTO / ANOTACION</strong> (requerido)</li>
                                    </ul>
                                </div>
                            </div>

                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                <strong>Detecci칩n Autom치tica:</strong> El sistema detectar치 autom치ticamente si tu
                                archivo tiene pesta침as llamadas "ingreso" y "estados" y las procesar치 de forma
                                especializada.
                            </small>
                        </div>

                        <form method="POST" enctype="multipart/form-data"
                            action="{{ url_for('idvistasubirexpediente.vista_subirexpediente') }}">
                            <!-- 游 CSRF Protection -->
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div class="form-group">
                                <label for="archivo_excel" class="font-weight-bold">
                                    <i class="fas fa-file-upload"></i> Seleccionar archivo Excel:
                                </label>
                                <input type="file" class="form-control-file" id="archivo_excel" name="archivo_excel"
                                    accept=".xlsx,.xls" required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> Formatos permitidos: .xlsx, .xls (m치ximo 10MB)
                                </small>
                            </div>

                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb"></i>
                                <strong>Detecci칩n Autom치tica:</strong> El sistema intentar치 leer autom치ticamente la hoja
                                m치s apropiada (Resumen por Expediente, Resumen, Expedientes, Hoja1, etc.) y detectar치
                                las columnas disponibles de forma inteligente.
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-upload"></i> Subir Archivo Excel
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Contenido: Actualizar desde Excel -->
            <div id="Excel_actualizacion" class="tabcontent">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-sync-alt"></i> Actualizar Expedientes Existentes desde Excel
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-4">Sube un archivo Excel para <strong>ACTUALIZAR</strong> expedientes
                            existentes. El sistema buscar치 los expedientes por radicado completo y actualizar치 su
                            informaci칩n:</p>

                        <div class="alert alert-warning mb-4">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Importante - Modo
                                Actualizaci칩n</h6>
                            <ul class="mb-0">
                                <li><strong>Solo actualiza expedientes existentes</strong> - No crea nuevos expedientes
                                </li>
                                <li><strong>Busca por RADICADO COMPLETO</strong> - Debe coincidir exactamente</li>
                                <li><strong>Actualiza solo los campos proporcionados</strong> - Los campos vac칤os no se
                                    modifican</li>
                                <li><strong>Radicados no encontrados se omiten</strong> - Se reportan en el resumen</li>
                            </ul>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-warning"><i class="fas fa-list"></i> Columnas Requeridas:</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item"><strong>RADICADO COMPLETO</strong> <span
                                            class="badge badge-danger">Obligatorio</span></li>
                                </ul>
                            </div>

                            <div class="col-md-6">
                                <h6 class="text-secondary"><i class="fas fa-list"></i> Columnas Actualizables:</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">DEMANDANTE</li>
                                    <li class="list-group-item">DEMANDADO</li>
                                    <li class="list-group-item">ESTADO</li>
                                    <li class="list-group-item">FECHA INGRESO</li>
                                    <li class="list-group-item">SOLICITUD</li>
                                    <li class="list-group-item">RESPONSABLE</li>
                                    <li class="list-group-item">OBSERVACIONES</li>
                                    <li class="list-group-item">UBICACION</li>
                                </ul>
                            </div>
                        </div>

                        <form method="POST" enctype="multipart/form-data"
                            action="{{ url_for('idvistasubirexpediente.vista_subirexpediente') }}">
                            <!-- 游 CSRF Protection -->
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="modo_actualizacion" value="true" />
                            <div class="form-group">
                                <label for="archivo_excel_actualizacion" class="font-weight-bold">
                                    <i class="fas fa-file-upload"></i> Seleccionar archivo Excel para actualizaci칩n:
                                </label>
                                <input type="file" class="form-control-file" id="archivo_excel_actualizacion"
                                    name="archivo_excel" accept=".xlsx,.xls" required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> Formatos permitidos: .xlsx, .xls (m치ximo 10MB)
                                </small>
                            </div>

                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb"></i>
                                <strong>Proceso de Actualizaci칩n:</strong>
                                <ol class="mb-0 mt-2">
                                    <li>El sistema busca cada expediente por su RADICADO COMPLETO</li>
                                    <li>Si el expediente existe, actualiza los campos proporcionados</li>
                                    <li>Si el expediente NO existe, se omite y se reporta</li>
                                    <li>Al finalizar, recibir치s un resumen detallado de las actualizaciones</li>
                                </ol>
                            </div>

                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="fas fa-sync-alt"></i> Actualizar Expedientes desde Excel
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Informaci칩n adicional -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle"></i> Informaci칩n Importante
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><strong>Formato de Radicados:</strong></h6>
                                    <ul class="small">
                                        <li><strong>Radicado Completo:</strong> Exactamente 23 d칤gitos num칠ricos (ej:
                                            08001418902020220003100)</li>
                                        <li><strong>Radicado Corto:</strong> Formato a침o-n칰mero (ej: 2022-00031)</li>
                                        <li>El radicado completo es obligatorio y debe tener 23 d칤gitos</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><strong>Validaciones:</strong></h6>
                                    <ul class="small">
                                        <li>Los radicados duplicados ser치n detectados autom치ticamente</li>
                                        <li>Los campos obligatorios est치n marcados</li>
                                        <li>Los archivos Excel deben tener las columnas correctas</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar reportes de errores -->
<div class="modal fade" id="modalReportes" tabindex="-1" role="dialog" aria-labelledby="modalReportesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalReportesLabel">
                    <i class="fas fa-file-download"></i> Reportes de Errores Disponibles
                </h5>
                <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button> -->
            </div>
            <div class="modal-body">
                <div id="loadingReportes" class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                    <p class="mt-3">Cargando reportes...</p>
                </div>
                
                <div id="contenidoReportes" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Informaci칩n:</strong> Aqu칤 puedes descargar los reportes de errores generados durante la carga y actualizaci칩n de expedientes.
                        Los reportes se mantienen por 90 d칤as. Se mostrara informaci칩n si previamente se cargo informaci칩n y hubo errores. <strong>Para cerrar esta pesta침a haz clic fuera de esta.</strong>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tablaReportes">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Total Filas</th>
                                    <th>Procesados</th>
                                    <th>Errores</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="bodyReportes">
                                <!-- Se llenar치 din치micamente con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="noReportes" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        No hay reportes disponibles en este momento.
                    </div>
                </div>
                
                <div id="errorReportes" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Error:</strong> <span id="mensajeError"></span>
                </div>
            </div>
            <!-- <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div> -->
        </div>
    </div>
</div>

<!-- Script para cargar reportes -->
<script>
    // Funci칩n para abrir el modal y cargar reportes
    function abrirModalReportes() {
        console.log('Abriendo modal de reportes...');
        
        // Abrir el modal usando Bootstrap
        if (typeof $ !== 'undefined' && $.fn.modal) {
            $('#modalReportes').modal('show');
            // Cargar reportes despu칠s de un peque침o delay
            setTimeout(cargarReportes, 300);
        } else {
            console.error('Bootstrap modal no est치 disponible');
            alert('Error: Bootstrap no est치 cargado correctamente');
        }
    }
    
    function cargarReportes() {
        console.log('Iniciando carga de reportes...');
        
        // Mostrar loading
        const loadingEl = document.getElementById('loadingReportes');
        const contenidoEl = document.getElementById('contenidoReportes');
        const errorEl = document.getElementById('errorReportes');
        
        if (loadingEl) loadingEl.style.display = 'block';
        if (contenidoEl) contenidoEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'none';
        
        // Hacer petici칩n AJAX
        fetch('{{ url_for("idvistasubirexpediente.listar_reportes") }}')
            .then(response => {
                console.log('Respuesta recibida:', response.status);
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Reportes recibidos:', data);
                
                // Ocultar loading
                if (loadingEl) loadingEl.style.display = 'none';
                if (contenidoEl) contenidoEl.style.display = 'block';
                
                const noReportesEl = document.getElementById('noReportes');
                const tablaEl = document.getElementById('tablaReportes');
                
                if (data.reportes && data.reportes.length > 0) {
                    mostrarReportes(data.reportes);
                    if (noReportesEl) noReportesEl.style.display = 'none';
                    if (tablaEl) tablaEl.style.display = 'table';
                } else {
                    if (noReportesEl) noReportesEl.style.display = 'block';
                    if (tablaEl) tablaEl.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error cargando reportes:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) errorEl.style.display = 'block';
                
                const mensajeErrorEl = document.getElementById('mensajeError');
                if (mensajeErrorEl) mensajeErrorEl.textContent = error.message;
            });
    }
    
    function mostrarReportes(reportes) {
        console.log('Mostrando ' + reportes.length + ' reportes');
        
        const tbody = document.getElementById('bodyReportes');
        if (!tbody) {
            console.error('Tbody no encontrado');
            return;
        }
        
        tbody.innerHTML = '';
        
        reportes.forEach(reporte => {
            const tipoLabel = reporte.tipo_reporte === 'actualizacion' 
                ? '<span class="badge badge-primary">Actualizaci칩n</span>' 
                : '<span class="badge badge-success">Carga Nuevos</span>';
            
            const totalErrores = (reporte.errores_validacion || 0) + (reporte.errores_tecnicos || 0) + (reporte.no_encontrados || 0);
            
            const urlDescarga = '{{ url_for("idvistasubirexpediente.descargar_reporte_bd", reporte_id=0) }}'.replace('0', reporte.id);
            
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td><small>${reporte.fecha_generacion}</small></td>
                <td><span class="badge badge-secondary">${tipoLabel}</span></td>
                <td><span class="badge badge-success">${reporte.total_filas}</span></td>
                <td><span class="badge badge-success">${reporte.actualizados}</span></td>
                <td><span class="badge badge-warning ">${totalErrores}</span></td>
                <td>
                    <a href="${urlDescarga}" 
                       class="btn btn-sm btn-primary" 
                       target="_blank"
                       title="Descargar reporte">
                        <i class="fas fa-download"></i> Descargar
                    </a>
                </td>
            `;
            
            tbody.appendChild(fila);
        });
        
        console.log('Reportes mostrados correctamente');
    }
</script>

<!-- Incluir CSS personalizado -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/subirexpediente.css') }}">

<!-- Script personalizado para pesta침as -->
<script src="{{ url_for('static', filename='js/subirexpediente.js') }}"></script>
{% endblock %}