{% extends "base.html" %}

{% block title %}Actualizar Expedientes{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-edit"></i> Actualizar Expedientes
            </h2>
            
            <!-- Mensajes de flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' if category == 'info' else 'warning' }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' if category == 'info' else 'exclamation-circle' }}"></i>
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Notificaci贸n especial cuando viene desde enlace de expediente -->
            {% if expediente and request.args.get('radicado') %}
            <div class="alert alert-primary alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <div class="mr-3">
                        <i class="fas fa-link fa-2x text-primary"></i>
                    </div>
                    <div>
                        <h6 class="alert-heading mb-1">
                            <i class="fas fa-magic"></i> Expediente Cargado Autom谩ticamente
                        </h6>
                        <p class="mb-0">
                            Este expediente se carg贸 autom谩ticamente desde la vista de consulta. 
                            Puedes editarlo directamente o buscar otro expediente usando el formulario de b煤squeda.
                        </p>
                    </div>
                </div>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endif %}
            
            <!-- Informaci贸n sobre roles -->
            <!-- <div class="alert alert-info mb-4">
                <h6><i class="fas fa-info-circle"></i> Informaci贸n sobre Asignaci贸n por Roles</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong><i class="fas fa-pen text-success"></i> ESCRIBIENTE:</strong>
                        <small class="text-muted d-block">Encargado de redacci贸n, documentaci贸n y actualizaci贸n de expedientes</small>
                    </div>
                    <div class="col-md-6">
                        <strong><i class="fas fa-gavel text-info"></i> SUSTANCIADOR:</strong>
                        <small class="text-muted d-block">Encargado de revisi贸n, an谩lisis y sustanciaci贸n de casos</small>
                    </div>
                </div>
                <hr class="my-2">
                <small class="text-muted">
                    <i class="fas fa-lightbulb"></i> 
                    <strong>Ventaja:</strong> Al asignar por rol, cualquier usuario con ese rol puede trabajar el expediente, 
                    proporcionando mayor flexibilidad en la gesti贸n de casos.
                </small>
            </div> -->
            
            <!-- Asignaci贸n Masiva -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-users-cog"></i> Asignaci贸n Masiva de Responsables
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Estad铆sticas r谩pidas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-black">
                                <div class="card-body text-center">
                                    <h4>{{ estadisticas.total_expedientes }}</h4>
                                    <small>Total Expedientes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-black">
                                <div class="card-body text-center">
                                    <h4>{{ estadisticas.sin_responsable }}</h4>
                                    <small>Sin Responsable</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-black">
                                <div class="card-body text-center">
                                    <h4>{{ estadisticas.escribientes }}</h4>
                                    <small>Escribientes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-black">
                                <div class="card-body text-center">
                                    <h4>{{ estadisticas.sustanciadores }}</h4>
                                    <small>Sustanciadores</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulario de asignaci贸n masiva -->
                    <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}" onsubmit="return confirmarAsignacionMasiva()">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="accion" value="asignacion_masiva">
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="criterio_masivo">Criterio de Asignaci贸n:</label>
                                    <select class="form-control" id="criterio_masivo" name="criterio_masivo" onchange="mostrarCampoValor()" required>
                                        <option value="">Seleccionar criterio</option>
                                        <option value="sin_responsable">Expedientes sin responsable</option>
                                        <option value="estado">Por estado espec铆fico</option>
                                        <option value="tipo_solicitud">Por tipo de solicitud</option>
                                        <option value="juzgado_origen">Por juzgado de origen</option>
                                        <option value="todos" class="text-danger">TODOS los expedientes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="valor_criterio">Valor del Criterio:</label>
                                    <div id="campo_valor_criterio">
                                        <input type="text" 
                                               class="form-control" 
                                               id="valor_criterio" 
                                               name="valor_criterio" 
                                               placeholder="Especificar valor..."
                                               class="form-control hidden-default" 
                                               id="valor_criterio" 
                                               name="valor_criterio" 
                                               placeholder="Especificar valor...">
                                        <select class="form-control hidden-default" id="valor_estado" name="valor_criterio">
                                            <option value="">Seleccionar estado</option>
                                            {% for estado in estadisticas.estados_comunes %}
                                                <option value="{{ estado[0] }}">{{ estado[0] }} ({{ estado[1] }} expedientes)</option>
                                            {% endfor %}
                                            <option value="EN_PROCESO">EN_PROCESO</option>
                                            <option value="COMPLETADO">COMPLETADO</option>
                                            <option value="PENDIENTE">PENDIENTE</option>
                                            <option value="PROCESADO_AZURE">PROCESADO_AZURE</option>
                                        </select>
                                        <small class="form-text text-muted hidden-default" id="ayuda_criterio">
                                            Este campo aparecer谩 seg煤n el criterio seleccionado
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="rol_masivo">Rol a Asignar:</label>
                                    <select class="form-control" id="rol_masivo" name="rol_masivo" required>
                                        <option value="">Seleccionar rol</option>
                                        {% for rol in roles %}
                                            <option value="{{ rol.nombre_rol }}">{{ rol.nombre_rol }}</option>
                                        {% endfor %}
                                        <option value="ALEATORIO">ALEATORIO (Escribiente/Sustanciador)</option>
                                        <option value="LIMPIAR" class="text-danger">LIMPIAR (Quitar todos los responsables)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        <strong>ALEATORIO:</strong> Asigna roles aleatorios | <strong>LIMPIAR:</strong> Quita todos los responsables
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Advertencia:</strong> Esta acci贸n asignar谩 el rol seleccionado a m煤ltiples expedientes seg煤n el criterio especificado. 
                                    Esta operaci贸n no se puede deshacer f谩cilmente.
                                </div>
                                
                                <button type="submit" class="btn btn-warning btn-lg">
                                    <i class="fas fa-magic"></i> Ejecutar Asignaci贸n Masiva
                                </button>
                                
                                <button type="button" class="btn btn-secondary btn-lg ml-2" onclick="limpiarFormularioMasivo()">
                                    <i class="fas fa-eraser"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Formulario de b煤squeda -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Buscar Expediente
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="accion" value="buscar">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="radicado_buscar">Radicado:</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="radicado_buscar" 
                                           name="radicado_buscar" 
                                           placeholder="Ej: 08001418901520250047500"
                                           required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Informaci贸n del expediente -->
            {% if expediente %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-folder"></i> Expediente: {{ expediente.radicado_completo or expediente.radicado_corto }}
                    </h5>
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('idvistaexpediente.vista_expediente') }}" 
                           class="btn btn-sm btn-outline-light" 
                           title="Volver a consultar expedientes">
                            <i class="fas fa-arrow-left"></i> Volver a Consulta
                        </a>
                        {% if request.args.get('radicado') %}
                        <button type="button" 
                                class="btn btn-sm btn-outline-light btn-ver-detalles" 
                                data-radicado="{{ request.args.get('radicado') }}"
                                title="Ver detalles completos de este expediente">
                            <i class="fas fa-eye"></i> Ver Detalles
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Formulario de actualizaci贸n de datos b谩sicos -->
                    <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="accion" value="actualizar">
                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                        
                        <h6 class="text-primary mb-3"><i class="fas fa-info-circle"></i> Datos B谩sicos</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Radicado Completo:</label>
                                    <input type="text" class="form-control" value="{{ expediente.radicado_completo or 'No disponible' }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Rol Responsable Actual:</label>
                                    <div class="form-control-plaintext">
                                        {% if expediente.responsable %}
                                            {% if expediente.responsable == 'ESCRIBIENTE' %}
                                                <span class="badge badge-success badge-lg">
                                                    <i class="fas fa-pen"></i> ESCRIBIENTE
                                                </span>
                                            {% elif expediente.responsable == 'SUSTANCIADOR' %}
                                                <span class="badge badge-info badge-lg">
                                                    <i class="fas fa-gavel"></i> SUSTANCIADOR
                                                </span>
                                            {% else %}
                                                <span class="badge badge-secondary badge-lg">
                                                    <i class="fas fa-user"></i> {{ expediente.responsable }}
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge badge-warning badge-lg">
                                                <i class="fas fa-exclamation-triangle"></i> Sin Asignar
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="demandante">Demandante:</label>
                                    <input type="text" class="form-control" id="demandante" name="demandante" 
                                           value="{{ expediente.demandante or '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="demandado">Demandado:</label>
                                    <input type="text" class="form-control" id="demandado" name="demandado" 
                                           value="{{ expediente.demandado or '' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="estado_actual">Estado Actual:</label>
                                    <select class="form-control" id="estado_actual" name="estado_actual">
                                        <option value="">Seleccionar estado</option>
                                        <option value="ACTIVO PENDIENTE" {{ 'selected' if expediente.estado_actual == 'ACTIVO PENDIENTE' }}>Activo Pendiente</option>
                                        <option value="ACTIVO RESUELTO" {{ 'selected' if expediente.estado_actual == 'ACTIVO RESUELTO' }}>Activo Resuelto</option>
                                        <option value="INACTIVO PENDIENTE" {{ 'selected' if expediente.estado_actual == 'INACTIVO PENDIENTE' }}>Inactivo Resuelto</option>
                                        <option value="INACTIVO RESUELTO" {{ 'selected' if expediente.estado_actual == 'INACTIVO RESUELTO' }}>Inactivo Resuelto</option>
                                        <option value="PENDIENTE" {{ 'selected' if expediente.estado_actual == 'PENDIENTE' }}>Pendiente</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="rol_responsable">Rol Responsable:</label>
                                    <div class="input-group">
                                        <select class="form-control" id="rol_responsable" name="rol_responsable">
                                            <option value="">Sin Asignar</option>
                                            {% for rol in roles %}
                                                <option value="{{ rol.nombre_rol }}" {{ 'selected' if expediente.responsable == rol.nombre_rol }}>
                                                    {{ rol.nombre_rol }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        {% if expediente.responsable %}
                                        <div class="input-group-append">
                                            <button type="button" 
                                                    class="btn btn-outline-danger" 
                                                    onclick="quitarResponsable()"
                                                    title="Quitar responsable">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        Selecciona "Sin Asignar" o usa el bot贸n <i class="fas fa-times"></i> para quitar el responsable
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="tipo_proceso">Tipo de Proceso:</label>
                                    <input type="text" class="form-control" id="tipo_proceso" name="tipo_proceso" 
                                           value="{{ expediente.tipo_proceso or '' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="observaciones">Observaciones:</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3">{{ expediente.observaciones or '' }}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Actualizar Datos B谩sicos
                        </button>
                    </form>
                    
                    <!-- Formulario oculto para quitar responsable -->
                    <form id="form-quitar-responsable" method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}" class="form-hidden">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="accion" value="quitar_responsable">
                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                    </form>
                    
                    <hr class="my-4">
                    
                    <!-- Nueva secci贸n: Asignar a Persona Espec铆fica (FUERA del formulario principal) -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card border-info mb-3">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-user-plus"></i> Asignar a Persona Espec铆fica
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> 
                                                Escribe el nombre de la persona. Aparecer谩n sugerencias de personas ya asignadas, o puedes escribir un nombre nuevo.
                                            </small>
                                        </p>
                                        <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}" class="form-inline">
                                            <!--  CSRF Protection -->
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <input type="hidden" name="accion" value="asignar_persona_especifica">
                                            <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                            
                                            <div class="form-group mr-2 flex-grow-1">
                                                <label for="nombre_persona_especifica" class="sr-only">Nombre de la persona:</label>
                                                <input type="text" 
                                                       class="form-control form-control-sm w-100" 
                                                       id="nombre_persona_especifica" 
                                                       name="nombre_persona_especifica" 
                                                       list="lista-personas"
                                                       placeholder="Escribe el nombre de la persona..."
                                                       autocomplete="off"
                                                       required>
                                                <datalist id="lista-personas">
                                                    <!-- Las opciones se cargar谩n din谩micamente -->
                                                </datalist>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-info btn-sm">
                                                <i class="fas fa-user-check"></i> Asignar Persona
                                            </button>
                                        </form>
                                        
                                        {% if expediente.responsable %}
                                        <div class="mt-2">
                                            <small class="text-success">
                                                <i class="fas fa-check-circle"></i> 
                                                <strong>Responsable actual:</strong> {{ expediente.responsable }}
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <script>
                        // Autocompletado de personas usando datalist
                        (function() {
                            const input = document.getElementById('nombre_persona_especifica');
                            const datalist = document.getElementById('lista-personas');
                            
                            if (!input || !datalist) return;
                            
                            let timeoutId = null;
                            let personasCache = [];
                            
                            // Funci贸n para cargar personas desde el servidor
                            function cargarPersonas(query) {
                                if (query.length < 2) {
                                    return;
                                }
                                
                                fetch(`{{ url_for('idvistaactualizarexpediente.api_buscar_personas') }}?q=${encodeURIComponent(query)}`)
                                    .then(response => response.json())
                                    .then(personas => {
                                        personasCache = personas;
                                        actualizarDatalist(personas);
                                    })
                                    .catch(error => {
                                        console.error('Error cargando personas:', error);
                                    });
                            }
                            
                            // Funci贸n para actualizar el datalist
                            function actualizarDatalist(personas) {
                                // Limpiar opciones existentes
                                datalist.innerHTML = '';
                                
                                // Agregar nuevas opciones
                                personas.forEach(persona => {
                                    const option = document.createElement('option');
                                    option.value = persona;
                                    datalist.appendChild(option);
                                });
                            }
                            
                            // Event listener para el input con debouncing
                            input.addEventListener('input', function() {
                                clearTimeout(timeoutId);
                                const query = this.value.trim();
                                
                                if (query.length < 2) {
                                    datalist.innerHTML = '';
                                    return;
                                }
                                
                                // Debounce: esperar 300ms despu茅s de que el usuario deje de escribir
                                timeoutId = setTimeout(() => {
                                    cargarPersonas(query);
                                }, 300);
                            });
                            
                            // Cargar personas iniciales al enfocar el campo
                            input.addEventListener('focus', function() {
                                if (datalist.children.length === 0 && this.value.length >= 2) {
                                    cargarPersonas(this.value);
                                }
                            });
                        })();
                        </script>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-4">
        
        <!-- Secci贸n de Ingresos -->
        <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-calendar-plus"></i> Historial de Ingresos</h6>
                            {% if expediente.ingresos %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Motivo</th>
                                                <th>Observaciones</th>
                                                <th width="60">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ingreso in expediente.ingresos[:2] %}
                                            <tr>
                                                <td><small>{{ ingreso[1].strftime('%d/%m/%Y') if ingreso[1] else 'N/A' }}</small></td>
                                                <td><small>{{ ingreso[2][:30] + '...' if ingreso[2] and ingreso[2]|length > 30 else (ingreso[2] or 'Sin motivo') }}</small></td>
                                                <td>
                                                    {% if ingreso[3] and ingreso[3]|length > 100 %}
                                                        <div class="observaciones-ingreso-container">
                                                            <small class="observaciones-ingreso-preview">{{ ingreso[3][:100] }}...</small>
                                                            <div class="observaciones-ingreso-full" style="display: none;">
                                                                <small>{{ ingreso[3] }}</small>
                                                            </div>
                                                            <br>
                                                            <button type="button" class="btn btn-sm btn-outline-primary btn-toggle-observaciones-ingreso" 
                                                                    onclick="toggleObservacionesIngresoText(this)">
                                                                <i class="fas fa-expand"></i> Ver completo
                                                            </button>
                                                        </div>
                                                    {% else %}
                                                        <small>{{ ingreso[3] or 'Sin observaciones' }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}" 
                                                          class="form-inline-display" 
                                                          onsubmit="return confirm('驴Est谩 seguro de eliminar este ingreso?')">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                        <input type="hidden" name="accion" value="eliminar_ingreso">
                                                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                                        <input type="hidden" name="ingreso_id" value="{{ ingreso[0] }}">
                                                        <button type="submit" class="btn btn-danger btn-xs" title="Eliminar ingreso">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            
                                            <!-- Ingresos adicionales (ocultos inicialmente) -->
                                            {% if expediente.ingresos|length > 2 %}
                                            <tbody id="ingresos-adicionales" class="hidden-default">
                                                {% for ingreso in expediente.ingresos[2:] %}
                                                <tr>
                                                    <td><small>{{ ingreso[1].strftime('%d/%m/%Y') if ingreso[1] else 'N/A' }}</small></td>
                                                    <td><small>{{ ingreso[2][:30] + '...' if ingreso[2] and ingreso[2]|length > 30 else (ingreso[2] or 'Sin motivo') }}</small></td>
                                                    <td>
                                                        {% if ingreso[3] and ingreso[3]|length > 100 %}
                                                            <div class="observaciones-ingreso-container">
                                                                <small class="observaciones-ingreso-preview">{{ ingreso[3][:100] }}...</small>
                                                                <div class="observaciones-ingreso-full" style="display: none;">
                                                                    <small>{{ ingreso[3] }}</small>
                                                                </div>
                                                                <br>
                                                                <button type="button" class="btn btn-sm btn-outline-primary btn-toggle-observaciones-ingreso" 
                                                                        onclick="toggleObservacionesIngresoText(this)">
                                                                    <i class="fas fa-expand"></i> Ver completo
                                                                </button>
                                                            </div>
                                                        {% else %}
                                                            <small>{{ ingreso[3] or 'Sin observaciones' }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}" 
                                                              style="display: inline;" 
                                                              onsubmit="return confirm('驴Est谩 seguro de eliminar este ingreso?')">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                            <input type="hidden" name="accion" value="eliminar_ingreso">
                                                            <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                                            <input type="hidden" name="ingreso_id" value="{{ ingreso[0] }}">
                                                            <button type="submit" class="btn btn-danger btn-xs" title="Eliminar ingreso">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Bot贸n para mostrar/ocultar ingresos adicionales -->
                                {% if expediente.ingresos|length > 2 %}
                                <div class="text-center mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleIngresosAdicionales()">
                                        <i class="fas fa-eye"></i> Ver todos ({{ expediente.ingresos|length }})
                                    </button>
                                </div>
                                {% endif %}
                            {% else %}
                                <p class="text-muted">No hay ingresos registrados</p>
                            {% endif %}
                            
                            <!-- Formulario para agregar ingreso -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Agregar Nuevo Ingreso</h6>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="accion" value="agregar_ingreso">
                                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                        
                                        <div class="form-group">
                                            <label for="nueva_fecha_ingreso">Fecha de Ingreso:</label>
                                            <input type="date" class="form-control" id="nueva_fecha_ingreso" name="nueva_fecha_ingreso" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="nuevo_motivo_ingreso">Motivo/Solicitud:</label>
                                            <input type="text" class="form-control" id="nuevo_motivo_ingreso" name="nuevo_motivo_ingreso" 
                                                   placeholder="Motivo del ingreso">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="nuevas_observaciones_ingreso">Observaciones:</label>
                                            <textarea class="form-control" id="nuevas_observaciones_ingreso" name="nuevas_observaciones_ingreso" 
                                                      rows="2" placeholder="Observaciones del ingreso"></textarea>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-plus"></i> Agregar Ingreso
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Secci贸n de Estados -->
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-history"></i> Historial de Estados</h6>
                            {% if expediente.estados %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Estado</th>
                                                <th>Observaciones</th>
                                                <th width="60">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for estado in expediente.estados[:2] %}
                                            <tr>
                                                <td><small>{{ estado[1].strftime('%d/%m/%Y') if estado[1] else 'N/A' }}</small></td>
                                                <td><span class="badge badge-info badge-sm">{{ estado[2][:15] + '...' if estado[2] and estado[2]|length > 15 else (estado[2] or 'Sin estado') }}</span></td>
                                                <td>
                                                    {% if estado[3] and estado[3]|length > 100 %}
                                                        <div class="observaciones-estado-container">
                                                            <small class="observaciones-estado-preview">{{ estado[3][:100] }}...</small>
                                                            <div class="observaciones-estado-full" style="display: none;">
                                                                <small>{{ estado[3] }}</small>
                                                            </div>
                                                            <br>
                                                            <button type="button" class="btn btn-sm btn-outline-primary btn-toggle-observaciones-estado" 
                                                                    onclick="toggleObservacionesEstadoText(this)">
                                                                <i class="fas fa-expand"></i> Ver completo
                                                            </button>
                                                        </div>
                                                    {% else %}
                                                        <small>{{ estado[3] or 'Sin observaciones' }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}" 
                                                          style="display: inline;" 
                                                          onsubmit="return confirm('驴Est谩 seguro de eliminar este estado?')">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                        <input type="hidden" name="accion" value="eliminar_estado">
                                                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                                        <input type="hidden" name="estado_id" value="{{ estado[0] }}">
                                                        <button type="submit" class="btn btn-danger btn-xs" title="Eliminar estado">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            
                                            <!-- Estados adicionales (ocultos inicialmente) -->
                                            {% if expediente.estados|length > 2 %}
                                            <tbody id="estados-adicionales" class="hidden-default">
                                                {% for estado in expediente.estados[2:] %}
                                                <tr>
                                                    <td><small>{{ estado[1].strftime('%d/%m/%Y') if estado[1] else 'N/A' }}</small></td>
                                                    <td><span class="badge badge-info badge-sm">{{ estado[2][:15] + '...' if estado[2] and estado[2]|length > 15 else (estado[2] or 'Sin estado') }}</span></td>
                                                    <td>
                                                        {% if estado[3] and estado[3]|length > 100 %}
                                                            <div class="observaciones-estado-container">
                                                                <small class="observaciones-estado-preview">{{ estado[3][:100] }}...</small>
                                                                <div class="observaciones-estado-full" style="display: none;">
                                                                    <small>{{ estado[3] }}</small>
                                                                </div>
                                                                <br>
                                                                <button type="button" class="btn btn-sm btn-outline-primary btn-toggle-observaciones-estado" 
                                                                        onclick="toggleObservacionesEstadoText(this)">
                                                                    <i class="fas fa-expand"></i> Ver completo
                                                                </button>
                                                            </div>
                                                        {% else %}
                                                            <small>{{ estado[3] or 'Sin observaciones' }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}" 
                                                              style="display: inline;" 
                                                              onsubmit="return confirm('驴Est谩 seguro de eliminar este estado?')">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                            <input type="hidden" name="accion" value="eliminar_estado">
                                                            <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                                            <input type="hidden" name="estado_id" value="{{ estado[0] }}">
                                                            <button type="submit" class="btn btn-danger btn-xs" title="Eliminar estado">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Bot贸n para mostrar/ocultar estados adicionales -->
                                {% if expediente.estados|length > 2 %}
                                <div class="text-center mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="toggleEstadosAdicionales()">
                                        <i class="fas fa-eye"></i> Ver todos ({{ expediente.estados|length }})
                                    </button>
                                </div>
                                {% endif %}
                            {% else %}
                                <p class="text-muted">No hay estados registrados</p>
                            {% endif %}
                            
                            <!-- Formulario para agregar estado -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Agregar Nuevo Estado</h6>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}">
                        <!--  CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="accion" value="agregar_estado">
                                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                        
                                        <div class="form-group">
                                            <label for="nueva_fecha_estado">Fecha del Estado:</label>
                                            <input type="date" class="form-control" id="nueva_fecha_estado" name="nueva_fecha_estado" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="nuevo_estado">Estado:</label>
                                            <select class="form-control" id="nuevo_estado" name="nuevo_estado" required>
                                                <option value="">Seleccionar estado</option>
                                                <option value="EN_PROCESO">En Proceso</option>
                                                <option value="COMPLETADO">Completado</option>
                                                <option value="PROCESADO_AZURE">Procesado Azure</option>
                                                <option value="PENDIENTE">Pendiente</option>
                                                <option value="SALIO">Sali贸</option>
                                                <option value="TERMINADO">Terminado</option>
                                                <option value="ARCHIVADO">Archivado</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="nuevas_observaciones_estado">Observaciones:</label>
                                            <textarea class="form-control" id="nuevas_observaciones_estado" name="nuevas_observaciones_estado" 
                                                      rows="2" placeholder="Observaciones del estado"></textarea>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-plus"></i> Agregar Estado
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informaci贸n adicional -->
                    <div class="mt-4 text-muted small">
                        <i class="fas fa-clock"></i> 
                        ltima actualizaci贸n: {{ expediente.fecha_ultima_actualizacion.strftime('%d/%m/%Y %H:%M') if expediente.fecha_ultima_actualizacion else 'No disponible' }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>


<script src="{{ url_for('static', filename='js/base.js') }}"></script>

{% endblock %}