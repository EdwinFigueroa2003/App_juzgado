{% extends "base.html" %}

{% block title %}Actualizar Expedientes{% endblock %}

{% block content %}
<style>
    /* Ocultar elementos adicionales por defecto */
    .hidden-default {
        display: none;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-edit"></i> Actualizar Expedientes
            </h2>

            <!-- Mensajes de flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' if category == 'info' else 'warning' }} alert-dismissible fade show"
                role="alert">
                <i
                    class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' if category == 'info' else 'exclamation-circle' }}"></i>
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <!-- Notificaci칩n especial cuando viene desde enlace de expediente -->
            {% if expediente and request.args.get('radicado') %}
            <div class="alert alert-primary alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <div class="mr-3">
                        <i class="fas fa-link fa-2x text-primary"></i>
                    </div>
                    <div>
                        <h6 class="alert-heading mb-1">
                            <i class="fas fa-magic"></i> Expediente Cargado Autom치ticamente
                        </h6>
                        <p class="mb-0">
                            Este expediente se carg칩 autom치ticamente desde la vista de consulta.
                            Puedes editarlo directamente o buscar otro expediente usando el formulario de b칰squeda.
                        </p>
                    </div>
                </div>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endif %}

            <!-- Informaci칩n sobre roles -->
            <!-- <div class="alert alert-info mb-4">
                <h6><i class="fas fa-info-circle"></i> Informaci칩n sobre Asignaci칩n por Roles</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong><i class="fas fa-pen text-success"></i> ESCRIBIENTE:</strong>
                        <small class="text-muted d-block">Encargado de redacci칩n, documentaci칩n y actualizaci칩n de expedientes</small>
                    </div>
                    <div class="col-md-6">
                        <strong><i class="fas fa-gavel text-info"></i> SUSTANCIADOR:</strong>
                        <small class="text-muted d-block">Encargado de revisi칩n, an치lisis y sustanciaci칩n de casos</small>
                    </div>
                </div>
                <hr class="my-2">
                <small class="text-muted">
                    <i class="fas fa-lightbulb"></i> 
                    <strong>Ventaja:</strong> Al asignar por rol, cualquier usuario con ese rol puede trabajar el expediente, 
                    proporcionando mayor flexibilidad en la gesti칩n de casos.
                </small>
            </div> -->

            <!-- Asignaci칩n Masiva -->
            {% if session.administrador %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-users-cog"></i> Asignaci칩n Masiva de Responsables
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Estad칤sticas r치pidas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-black">
                                <div class="card-body text-center">
                                    <h4>{{ estadisticas.total_expedientes }}</h4>
                                    <small><!-- Total --> Expedientes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-black">
                                <div class="card-body text-center">
                                    <h4>{{ estadisticas.sin_responsable }}</h4>
                                    <small>Sin Responsable</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-black">
                                <div class="card-body text-center">
                                    <h4>{{ estadisticas.escribientes }}</h4>
                                    <small>Escribientes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-black">
                                <div class="card-body text-center">
                                    <h4>{{ estadisticas.sustanciadores }}</h4>
                                    <small>Sustanciadores</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de asignaci칩n masiva -->
                    <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}"
                        onsubmit="return confirmarAsignacionMasiva()">
                        <!-- 游 CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="accion" value="asignacion_masiva">

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="criterio_masivo">Criterio de Asignaci칩n:</label>
                                    <select class="form-control" id="criterio_masivo" name="criterio_masivo"
                                        onchange="mostrarCampoValor()" required>
                                        <option value="">Seleccionar criterio</option>
                                        <option value="sin_responsable">Expedientes sin responsable</option>
                                        <option value="estado">Por estado espec칤fico</option>
                                        <option value="tipo_solicitud">Por tipo de solicitud</option>
                                        <!-- <option value="juzgado_origen">Por juzgado de origen</option> -->
                                        <option value="todos" class="text-danger">TODOS los expedientes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="valor_criterio">Valor del Criterio:</label>
                                    <div id="campo_valor_criterio">
                                        <input type="text" class="form-control" id="valor_criterio"
                                            name="valor_criterio" placeholder="Especificar valor..."
                                            style="display: none;">
                                        <select class="form-control" id="valor_estado"
                                            name="valor_criterio" style="display: none;">
                                            <option value="">Seleccionar estado</option>
                                            {% for estado in estadisticas.estados_comunes %}
                                            <option value="{{ estado[0] }}">{{ estado[0] }} ({{ estado[1] }}
                                                expedientes)</option>
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted" id="ayuda_criterio" style="display: none;">
                                            Este campo aparecer치 seg칰n el criterio seleccionado
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="rol_masivo">Rol a Asignar:</label>
                                    <select class="form-control" id="rol_masivo" name="rol_masivo" required>
                                        <option value="">Seleccionar rol</option>
                                        {% for rol in roles %}
                                        <option value="{{ rol.nombre_rol }}">{{ rol.nombre_rol }}</option>
                                        {% endfor %}
                                        <option value="ALEATORIO">ALEATORIO (Escribiente/Sustanciador)</option>
                                        <option value="LIMPIAR" class="text-danger">LIMPIAR (Quitar todos los
                                            responsables)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>ALEATORIO:</strong> Asigna roles aleatorios | <strong>LIMPIAR:</strong>
                                        Quita todos los responsables
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Nueva fila para cantidad l칤mite -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="cantidad_limite">Cantidad L칤mite (Opcional):</label>
                                    <select class="form-control" id="cantidad_limite" name="cantidad_limite">
                                        <option value="">Sin l칤mite (todos los que cumplan el criterio)</option>
                                        <option value="50">50 expedientes</option>
                                        <option value="100">100 expedientes</option>
                                        <option value="150">150 expedientes</option>
                                        <option value="200">200 expedientes</option>
                                        <option value="250">250 expedientes</option>
                                        <option value="500">500 expedientes</option>
                                        <option value="1000">1000 expedientes</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>L칤mite:</strong> Restringe la asignaci칩n a una cantidad espec칤fica de expedientes (se toman los m치s antiguos primero)
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="cantidad_personalizada">O Cantidad Personalizada:</label>
                                    <input type="number" class="form-control" id="cantidad_personalizada" 
                                           placeholder="Ej: 75" min="1" max="10000"
                                           onchange="actualizarCantidadLimite()">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-edit"></i>
                                        Ingresa un n칰mero personalizado (1-10,000)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Advertencia:</strong> Esta acci칩n asignar치 el rol seleccionado a m칰ltiples
                                    expedientes seg칰n el criterio especificado.
                                    Esta operaci칩n no se puede deshacer f치cilmente.
                                </div>

                                <button type="submit" class="btn btn-warning btn-lg">
                                    <i class="fas fa-magic"></i> Ejecutar Asignaci칩n Masiva
                                </button>

                                <button type="button" class="btn btn-secondary btn-lg ml-2"
                                    onclick="limpiarFormularioMasivo()">
                                    <i class="fas fa-eraser"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Formulario de b칰squeda -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Buscar Expediente
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST"
                        action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}">
                        <!-- 游 CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="accion" value="buscar">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="radicado_buscar">Radicado:</label>
                                    <input type="text" class="form-control" id="radicado_buscar" name="radicado_buscar"
                                        placeholder="Ej: 08001418901520250047500" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary btn-block" style="margin-top: 9.5%;">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Informaci칩n del expediente -->
            {% if expediente %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-folder"></i> Expediente: {{ expediente.radicado_completo or
                        expediente.radicado_corto }}
                    </h5>
                    <div class="btn-group" role="group">
                        {% if request.args.get('buscar_id') %}
                        <!-- Si viene desde asignaciones, volver a asignaciones -->
                        <a href="{{ url_for('idvistaasignacion.vista_asignacion') }}"
                            class="btn btn-sm btn-outline-light" title="Volver a mis asignaciones">
                            <i class="fas fa-arrow-left"></i> Volver a Asignaciones
                        </a>
                        {% else %}
                        <!-- Si viene desde consulta general, volver a consulta -->
                        <a href="{{ url_for('idvistaexpediente.vista_expediente') }}"
                            class="btn btn-sm btn-outline-light" title="Volver a consultar expedientes">
                            <i class="fas fa-arrow-left"></i> Volver a Consulta
                        </a>
                        {% endif %}
                        {% if request.args.get('radicado') %}
                        <button type="button" class="btn btn-sm btn-outline-light btn-ver-detalles"
                            data-radicado="{{ request.args.get('radicado') }}"
                            title="Ver detalles completos de este expediente">
                            <i class="fas fa-eye"></i> Ver Detalles
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Formulario de actualizaci칩n de datos b치sicos -->
                    <form method="POST"
                        action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}">
                        <!-- 游 CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="accion" value="actualizar">
                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">

                        <h6 class="text-primary mb-3"><i class="fas fa-info-circle"></i> Datos B치sicos</h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="radicado_completo">Radicado Completo:</label>
                                    <input type="text" class="form-control" id="radicado_completo"
                                        name="radicado_completo" value="{{ expediente.radicado_completo or '' }}"
                                        placeholder="Ej: 08001418901520250047500">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> Puedes modificar el radicado completo si es
                                        necesario
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Rol/Responsable Actual:</label>
                                    <div class="form-control-plaintext">
                                        {% if expediente.responsable %}
                                        {% if expediente.responsable == 'ESCRIBIENTE' %}
                                        <span class="badge badge-success badge-lg">
                                            <i class="fas fa-pen"></i> ESCRIBIENTE
                                        </span>
                                        {% elif expediente.responsable == 'SUSTANCIADOR' %}
                                        <span class="badge badge-info badge-lg">
                                            <i class="fas fa-gavel"></i> SUSTANCIADOR
                                        </span>
                                        {% else %}
                                        <span class="badge badge-secondary badge-lg">
                                            <i class="fas fa-user"></i> {{ expediente.responsable }}
                                        </span>
                                        {% endif %}
                                        {% else %}
                                        <span class="badge badge-warning badge-lg">
                                            <i class="fas fa-exclamation-triangle"></i> Sin Asignar
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Estado Actual:</label>
                                    <div class="form-control-plaintext">
                                        {% if expediente.estado_actual %}
                                        {% if expediente.estado_actual == 'Activo Pendiente' %}
                                        <span class="badge badge-warning badge-lg">
                                            <i class="fas fa-clock"></i> Activo Pendiente
                                        </span>
                                        {% if expediente.turno %}
                                        <br><small class="text-muted mt-1">
                                            <i class="fas fa-sort-numeric-up"></i> Turno: {{ expediente.turno }}
                                        </small>
                                        {% endif %}
                                        {% elif expediente.estado_actual == 'Activo Resuelto' %}
                                        <span class="badge badge-success badge-lg">
                                            <i class="fas fa-check-circle"></i> Activo Resuelto
                                        </span>
                                        {% elif expediente.estado_actual == 'Inactivo Resuelto' %}
                                        <span class="badge badge-secondary badge-lg">
                                            <i class="fas fa-archive"></i> Inactivo Resuelto
                                        </span>
                                        {% elif expediente.estado_actual == 'Pendiente' %}
                                        <span class="badge badge-light badge-lg">
                                            <i class="fas fa-pause-circle"></i> Pendiente
                                        </span>
                                        {% else %}
                                        <span class="badge badge-info badge-lg">
                                            <i class="fas fa-info-circle"></i> {{ expediente.estado_actual }}
                                        </span>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-dark">
                                            <i class="fas fa-question-circle"></i> Sin Estado
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="demandante">Demandante:</label>
                                    <input type="text" class="form-control" id="demandante" name="demandante"
                                        value="{{ expediente.demandante or '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="demandado">Demandado:</label>
                                    <input type="text" class="form-control" id="demandado" name="demandado"
                                        value="{{ expediente.demandado or '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="estado_actual">Estado Actual:</label>
                                    <select class="form-control" id="estado_actual" name="estado_actual">
                                        <option value="">Seleccionar estado</option>
                                        <option value="Activo Pendiente" {{ 'selected' if
                                            expediente.estado_actual=='Activo Pendiente' }}>Activo Pendiente</option>

                                        <option value="Activo Resuelto" {{ 'selected' if
                                            expediente.estado_actual=='Activo Resuelto' }}>Activo Resuelto</option>

                                        <option value="Inactivo Pendiente" {{ 'selected' if
                                            expediente.estado_actual=='Inactivo Pendiente' }}>Inactivo Pendiente</option>

                                        <option value="Inactivo Resuelto" {{ 'selected' if
                                            expediente.estado_actual=='Inactivo Resuelto' }}>Inactivo Resuelto</option>

                                        <option value="Pendiente" {{ 'selected' if expediente.estado_actual=='Pendiente'
                                            }}>Pendiente</option>

                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="fecha_ingreso_expediente">Fecha de Ingreso:</label>
                                    <input type="date" class="form-control" id="fecha_ingreso_expediente" 
                                           name="fecha_ingreso_expediente"
                                           value="{{ expediente.fecha_ingreso.strftime('%Y-%m-%d') if expediente.fecha_ingreso else '' }}">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        Cambiar esta fecha recalcular치 autom치ticamente los turnos
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {% if session.administrador %}
                                        <label for="rol_responsable">Rol/Responsable:</label>
                                        <div class="input-group">
                                            <select class="form-control" id="rol_responsable" name="rol_responsable">
                                                <option value="">Sin Asignar</option>
                                                {% for rol in roles %}
                                                <option value="{{ rol.nombre_rol }}" {{ 'selected' if
                                                    expediente.responsable==rol.nombre_rol }}>
                                                    {{ rol.nombre_rol }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            {% if expediente.responsable %}
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-outline-danger"
                                                    onclick="quitarResponsable()" title="Quitar responsable">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Selecciona "Sin Asignar" o usa el bot칩n <i class="fas fa-times"></i> para quitar
                                            el responsable
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="tipo_proceso">Tipo de Proceso:</label>
                                    <input type="text" class="form-control" id="tipo_proceso" name="tipo_proceso"
                                        value="{{ expediente.tipo_proceso or '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="observaciones">Observaciones:</label>
                            <textarea class="form-control" id="observaciones" name="observaciones"
                                rows="3">{{ expediente.observaciones or '' }}</textarea>
                        </div>

                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Actualizar Datos B치sicos
                        </button>
                    </form>
                    {% if session.administrador %}
                        <!-- Formulario separado para eliminar expediente -->
                        <form method="POST" action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}"
                            class="d-inline-block ml-2"
                            onsubmit="return confirmarEliminacionExpediente('{{ expediente.radicado_completo or expediente.radicado_corto }}')">
                            <!-- 游 CSRF Protection -->
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="accion" value="eliminar_expediente">
                            <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash-alt"></i> Eliminar Expediente
                            </button>
                        </form>
                    {% endif %}


                    <!-- Formulario oculto para quitar responsable -->
                    <form id="form-quitar-responsable" method="POST"
                        action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}"
                        class="form-hidden">
                        <!-- 游 CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="accion" value="quitar_responsable">
                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                    </form>

                    <hr class="my-4">

                    <!-- Nueva secci칩n: Asignar a Persona Espec칤fica (FUERA del formulario principal) -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card border-info mb-3">
                                <div class="card-header bg-info text-white">
                                    <i class="fas fa-user-plus"></i> Asignar a Persona Espec칤fica
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Escribe el nombre de la persona. Aparecer치n sugerencias de personas ya
                                            asignadas, o puedes escribir un nombre nuevo.
                                        </small>
                                    </p>
                                    <form method="POST"
                                        action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}"
                                        class="form-inline">
                                        <!-- 游 CSRF Protection -->
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                        <input type="hidden" name="accion" value="asignar_persona_especifica">
                                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">

                                        <div class="form-group mr-2 flex-grow-1">
                                            <label for="nombre_persona_especifica" class="sr-only">Nombre de la
                                                persona:</label>
                                            <input type="text" class="form-control form-control-sm w-100"
                                                id="nombre_persona_especifica" name="nombre_persona_especifica"
                                                list="lista-personas" placeholder="Escribe el nombre de la persona..."
                                                autocomplete="off" required>
                                            <datalist id="lista-personas">
                                                <!-- Las opciones se cargar치n din치micamente -->
                                            </datalist>
                                        </div>

                                        <button type="submit" class="btn btn-info btn-sm">
                                            <i class="fas fa-user-check"></i> Asignar Persona
                                        </button>
                                    </form>

                                    {% if expediente.responsable %}
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="fas fa-check-circle"></i>
                                            <strong>Responsable actual:</strong> {{ expediente.responsable }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        // Autocompletado de personas usando datalist
                        (function () {
                            const input = document.getElementById('nombre_persona_especifica');
                            const datalist = document.getElementById('lista-personas');

                            if (!input || !datalist) return;

                            let timeoutId = null;
                            let personasCache = [];

                            // Funci칩n para cargar personas desde el servidor
                            function cargarPersonas(query) {
                                if (query.length < 2) {
                                    return;
                                }

                                fetch(`{{ url_for('idvistaactualizarexpediente.api_buscar_personas') }}?q=${encodeURIComponent(query)}`)
                                    .then(response => response.json())
                                    .then(personas => {
                                        personasCache = personas;
                                        actualizarDatalist(personas);
                                    })
                                    .catch(error => {
                                        console.error('Error cargando personas:', error);
                                    });
                            }

                            // Funci칩n para actualizar el datalist
                            function actualizarDatalist(personas) {
                                // Limpiar opciones existentes
                                datalist.innerHTML = '';

                                // Agregar nuevas opciones
                                personas.forEach(persona => {
                                    const option = document.createElement('option');
                                    option.value = persona;
                                    datalist.appendChild(option);
                                });
                            }

                            // Event listener para el input con debouncing
                            input.addEventListener('input', function () {
                                clearTimeout(timeoutId);
                                const query = this.value.trim();

                                if (query.length < 2) {
                                    datalist.innerHTML = '';
                                    return;
                                }

                                // Debounce: esperar 300ms despu칠s de que el usuario deje de escribir
                                timeoutId = setTimeout(() => {
                                    cargarPersonas(query);
                                }, 300);
                            });

                            // Cargar personas iniciales al enfocar el campo
                            input.addEventListener('focus', function () {
                                if (datalist.children.length === 0 && this.value.length >= 2) {
                                    cargarPersonas(this.value);
                                }
                            });
                        })();
                    </script>

                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">

    <!-- Secci칩n de Ingresos -->
    <div class="row">
        <div class="col-md-6">
            <h6 class="text-primary"><i class="fas fa-calendar-plus"></i> Historial de Ingresos</h6>
            {% if expediente.ingresos %}
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Solicitud</th>
                            <th>Observaciones</th>
                            <th width="60">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ingreso in expediente.ingresos[:2] %}
                        <tr>
                            <td><small>{{ ingreso[1].strftime('%d/%m/%Y') if ingreso[1] else 'N/A' }}</small></td>
                            <td><small>{{ ingreso[3][:30] + '...' if ingreso[3] and ingreso[3]|length > 30 else
                                    (ingreso[3] or 'Sin solicitud') }}</small></td>
                            <td>
                                {% if ingreso[2] and ingreso[2]|length > 50 %}
                                <div class="observaciones-ingreso-container">
                                    <small class="observaciones-ingreso-preview">{{ ingreso[2][:50] }}...</small>
                                    <div class="observaciones-ingreso-full" style="display: none;">
                                        <small>{{ ingreso[2] }}</small>
                                    </div>
                                    <br>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-primary btn-toggle-observaciones-ingreso"
                                        onclick="toggleObservacionesIngresoText(this)">
                                        <i class="fas fa-expand"></i> Ver completo
                                    </button>
                                </div>
                                {% else %}
                                <small>{{ ingreso[2] or 'Sin observaciones' }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST"
                                    action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}"
                                    class="form-inline-display"
                                    onsubmit="return confirm('쮼st치 seguro de eliminar este ingreso?')">
                                    <!-- 游 CSRF Protection -->
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <input type="hidden" name="accion" value="eliminar_ingreso">
                                    <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                    <input type="hidden" name="ingreso_id" value="{{ ingreso[0] }}">
                                    <button type="submit" class="btn btn-danger btn-xs" title="Eliminar ingreso">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}

                        <!-- Ingresos adicionales (ocultos inicialmente) -->
                        {% if expediente.ingresos|length > 2 %}
                    <tbody id="ingresos-adicionales" class="hidden-default">
                        {% for ingreso in expediente.ingresos[2:] %}
                        <tr>
                            <td><small>{{ ingreso[1].strftime('%d/%m/%Y') if ingreso[1] else 'N/A' }}</small></td>
                            <td><small>{{ ingreso[3][:30] + '...' if ingreso[3] and ingreso[3]|length > 30 else
                                    (ingreso[3] or 'Sin solicitud') }}</small></td>
                            <td>
                                {% if ingreso[2] and ingreso[2]|length > 50 %}
                                <div class="observaciones-ingreso-container">
                                    <small class="observaciones-ingreso-preview">{{ ingreso[2][:50] }}...</small>
                                    <div class="observaciones-ingreso-full" style="display: none;">
                                        <small>{{ ingreso[2] }}</small>
                                    </div>
                                    <br>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-primary btn-toggle-observaciones-ingreso"
                                        onclick="toggleObservacionesIngresoText(this)">
                                        <i class="fas fa-expand"></i> Ver completo
                                    </button>
                                </div>
                                {% else %}
                                <small>{{ ingreso[2] or 'Sin observaciones' }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST"
                                    action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}"
                                    style="display: inline;"
                                    onsubmit="return confirm('쮼st치 seguro de eliminar este ingreso?')">
                                    <!-- 游 CSRF Protection -->
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <input type="hidden" name="accion" value="eliminar_ingreso">
                                    <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                    <input type="hidden" name="ingreso_id" value="{{ ingreso[0] }}">
                                    <button type="submit" class="btn btn-danger btn-xs" title="Eliminar ingreso">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Bot칩n para mostrar/ocultar ingresos adicionales -->
            {% if expediente.ingresos|length > 2 %}
            <div class="text-center mt-2">
                <button type="button" class="btn btn-sm btn-outline-info btn-toggle-ingresos">
                    <i class="fas fa-eye"></i> Ver todos ({{ expediente.ingresos|length }})
                </button>
            </div>
            {% endif %}
            {% else %}
            <p class="text-muted">No hay ingresos registrados</p>
            {% endif %}

            <!-- Formulario para agregar ingreso -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Agregar Nuevo Ingreso</h6>
                </div>
                <div class="card-body">
                    <form method="POST"
                        action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}">
                        <!-- 游 CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="accion" value="agregar_ingreso">
                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">

                        <div class="form-group">
                            <label for="nueva_fecha_ingreso">Fecha de Ingreso:</label>
                            <input type="date" class="form-control" id="nueva_fecha_ingreso" name="nueva_fecha_ingreso"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="nuevo_motivo_ingreso">Motivo/Solicitud:</label>
                            <input type="text" class="form-control" id="nuevo_motivo_ingreso"
                                name="nuevo_motivo_ingreso" placeholder="Motivo del ingreso">
                        </div>

                        <div class="form-group">
                            <label for="nuevas_observaciones_ingreso">Observaciones:</label>
                            <textarea class="form-control" id="nuevas_observaciones_ingreso"
                                name="nuevas_observaciones_ingreso" rows="2"
                                placeholder="Observaciones del ingreso"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> Agregar Ingreso
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Secci칩n de Estados -->
        <div class="col-md-6">
            <h6 class="text-primary"><i class="fas fa-history"></i> Historial de Estados</h6>
            {% if expediente.estados %}
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Clase</th>
                            <th>Auto/Anotaci칩n</th>
                            <th>Observaciones</th>
                            <th width="60">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for estado in expediente.estados[:2] %}
                        <tr>
                            <td><small>{{ estado[1].strftime('%d/%m/%Y') if estado[1] else 'N/A' }}</small></td>
                            <td><span class="badge badge-secondary badge-sm">{{ estado[2][:20] + '...' if estado[2] and
                                    estado[2]|length > 20 else (estado[2] or 'Sin clase') }}</span></td>
                            <td>
                                {% if estado[3] and estado[3]|length > 50 %}
                                <div class="auto-anotacion-container">
                                    <small class="auto-anotacion-preview">{{ estado[3][:50] }}...</small>
                                    <div class="auto-anotacion-full" style="display: none;">
                                        <small>{{ estado[3] }}</small>
                                    </div>
                                    <br>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-primary btn-toggle-auto-anotacion"
                                        onclick="toggleAutoAnotacionText(this)">
                                        <i class="fas fa-expand"></i> Ver completo
                                    </button>
                                </div>
                                {% else %}
                                <small>{{ estado[3] or 'Sin auto/anotaci칩n' }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if estado[4] and estado[4]|length > 50 %}
                                <div class="observaciones-estado-container">
                                    <small class="observaciones-estado-preview">{{ estado[4][:50] }}...</small>
                                    <div class="observaciones-estado-full" style="display: none;">
                                        <small>{{ estado[4] }}</small>
                                    </div>
                                    <br>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-primary btn-toggle-observaciones-estado"
                                        onclick="toggleObservacionesEstadoText(this)">
                                        <i class="fas fa-expand"></i> Ver completo
                                    </button>
                                </div>
                                {% else %}
                                <small>{{ estado[4] or 'Sin observaciones' }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST"
                                    action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}"
                                    style="display: inline;"
                                    onsubmit="return confirm('쮼st치 seguro de eliminar este estado?')">
                                    <!-- 游 CSRF Protection -->
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <input type="hidden" name="accion" value="eliminar_estado">
                                    <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                    <input type="hidden" name="estado_id" value="{{ estado[0] }}">
                                    <button type="submit" class="btn btn-danger btn-xs" title="Eliminar estado">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}

                        <!-- Estados adicionales (ocultos inicialmente) -->
                        {% if expediente.estados|length > 2 %}
                    <tbody id="estados-adicionales" class="hidden-default">
                        {% for estado in expediente.estados[2:] %}
                        <tr>
                            <td><small>{{ estado[1].strftime('%d/%m/%Y') if estado[1] else 'N/A' }}</small></td>
                            <td><span class="badge badge-secondary badge-sm">{{ estado[2][:20] + '...' if estado[2] and
                                    estado[2]|length > 20 else (estado[2] or 'Sin clase') }}</span></td>
                            <td>
                                {% if estado[3] and estado[3]|length > 50 %}
                                <div class="auto-anotacion-container">
                                    <small class="auto-anotacion-preview">{{ estado[3][:50] }}...</small>
                                    <div class="auto-anotacion-full" style="display: none;">
                                        <small>{{ estado[3] }}</small>
                                    </div>
                                    <br>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-primary btn-toggle-auto-anotacion"
                                        onclick="toggleAutoAnotacionText(this)">
                                        <i class="fas fa-expand"></i> Ver completo
                                    </button>
                                </div>
                                {% else %}
                                <small>{{ estado[3] or 'Sin auto/anotaci칩n' }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if estado[4] and estado[4]|length > 50 %}
                                <div class="observaciones-estado-container">
                                    <small class="observaciones-estado-preview">{{ estado[4][:50] }}...</small>
                                    <div class="observaciones-estado-full" style="display: none;">
                                        <small>{{ estado[4] }}</small>
                                    </div>
                                    <br>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-primary btn-toggle-observaciones-estado"
                                        onclick="toggleObservacionesEstadoText(this)">
                                        <i class="fas fa-expand"></i> Ver completo
                                    </button>
                                </div>
                                {% else %}
                                <small>{{ estado[4] or 'Sin observaciones' }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST"
                                    action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}"
                                    style="display: inline;"
                                    onsubmit="return confirm('쮼st치 seguro de eliminar este estado?')">
                                    <!-- 游 CSRF Protection -->
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <input type="hidden" name="accion" value="eliminar_estado">
                                    <input type="hidden" name="expediente_id" value="{{ expediente.id }}">
                                    <input type="hidden" name="estado_id" value="{{ estado[0] }}">
                                    <button type="submit" class="btn btn-danger btn-xs" title="Eliminar estado">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Bot칩n para mostrar/ocultar estados adicionales -->
            {% if expediente.estados|length > 2 %}
            <div class="text-center mt-2">
                <button type="button" class="btn btn-sm btn-outline-warning btn-toggle-estados">
                    <i class="fas fa-eye"></i> Ver todos ({{ expediente.estados|length }})
                </button>
            </div>
            {% endif %}
            {% else %}
            <p class="text-muted">No hay estados registrados</p>
            {% endif %}

            <!-- Formulario para agregar estado -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Agregar Nuevo Estado</h6>
                </div>
                <div class="card-body">
                    <form method="POST"
                        action="{{ url_for('idvistaactualizarexpediente.vista_actualizarexpediente') }}">
                        <!-- 游 CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="accion" value="agregar_estado">
                        <input type="hidden" name="expediente_id" value="{{ expediente.id }}">

                        <div class="form-group">
                            <label for="nueva_fecha_estado">Fecha del Estado:</label>
                            <input type="date" class="form-control" id="nueva_fecha_estado" name="nueva_fecha_estado"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="nuevo_estado">Clase:</label>
                            <select class="form-control" id="nuevo_estado" name="nuevo_estado" required>
                                <option value="">Seleccionar clase</option>
                                <option value="Ejecutivos De M칤nima Cuant칤a">Ejecutivos De M칤nima Cuant칤a</option>
                                <option value="Ejecutivos De Mayor Cuant칤a">Ejecutivos De Mayor Cuant칤a</option>
                                <option value="Declarativos">Declarativos</option>
                                <option value="Especiales">Especiales</option>
                                <option value="Terminado">Terminado</option>
                                <option value="Archivado">Archivado</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="nueva_auto_anotacion">Auto/Anotaci칩n:</label>
                            <textarea class="form-control" id="nueva_auto_anotacion" name="nueva_auto_anotacion"
                                rows="3" placeholder="Auto o anotaci칩n del estado"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="nuevas_observaciones_estado">Observaciones:</label>
                            <textarea class="form-control" id="nuevas_observaciones_estado"
                                name="nuevas_observaciones_estado" rows="2"
                                placeholder="Observaciones del estado"></textarea>
                        </div>

                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="fas fa-plus"></i> Agregar Estado
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci칩n adicional -->
    <div class="mt-4 text-muted small">
        <i class="fas fa-clock"></i>
        칔ltima actualizaci칩n: {{ expediente.fecha_ultima_actualizacion.strftime('%d/%m/%Y %H:%M') if
        expediente.fecha_ultima_actualizacion else 'No disponible' }}
    </div>
</div>
</div>
{% endif %}
</div>
</div>
</div>


<script>
    // Funci칩n para confirmar eliminaci칩n de expediente
    function confirmarEliminacionExpediente(radicado) {
        const mensaje = `쮼st치 COMPLETAMENTE SEGURO de que desea ELIMINAR el expediente ${radicado}?\n\n` +
            `丘멆잺 ADVERTENCIA: Esta acci칩n es IRREVERSIBLE y eliminar치:\n` +
            ` El expediente completo\n` +
            ` Todos sus ingresos\n` +
            ` Todos sus estados\n` +
            ` Todas sus actuaciones\n\n` +
            `Escriba "ELIMINAR" para confirmar:`;

        const confirmacion = prompt(mensaje);

        if (confirmacion === "ELIMINAR") {
            return confirm("쮼st치 100% seguro? Esta acci칩n NO se puede deshacer.");
        }

        return false;
    }

    // Funci칩n para actualizar cantidad l칤mite con valor personalizado
    function actualizarCantidadLimite() {
        const cantidadPersonalizada = document.getElementById('cantidad_personalizada');
        const cantidadLimite = document.getElementById('cantidad_limite');
        
        if (cantidadPersonalizada.value && cantidadPersonalizada.value.trim() !== '') {
            const valor = parseInt(cantidadPersonalizada.value);
            if (valor > 0 && valor <= 10000) {
                // Limpiar opciones personalizadas anteriores
                const opciones = cantidadLimite.querySelectorAll('option');
                opciones.forEach(opcion => {
                    if (opcion.text.includes('(personalizado)')) {
                        opcion.remove();
                    }
                });
                
                // Crear nueva opci칩n con el valor personalizado
                const nuevaOpcion = new Option(`${valor} expedientes (personalizado)`, valor, true, true);
                cantidadLimite.appendChild(nuevaOpcion);
                cantidadLimite.value = valor;
            } else {
                alert('La cantidad debe estar entre 1 y 10,000');
                cantidadPersonalizada.value = '';
            }
        }
    }

    // Funci칩n para limpiar formulario masivo
    function limpiarFormularioMasivo() {
        document.getElementById('criterio_masivo').value = '';
        document.getElementById('valor_criterio').value = '';
        document.getElementById('rol_masivo').value = '';
        document.getElementById('cantidad_limite').value = '';
        document.getElementById('cantidad_personalizada').value = '';
        
        // Limpiar opciones personalizadas del select
        const cantidadLimite = document.getElementById('cantidad_limite');
        const opciones = cantidadLimite.querySelectorAll('option');
        opciones.forEach(opcion => {
            if (opcion.text.includes('(personalizado)')) {
                opcion.remove();
            }
        });
        
        // Ocultar campos de valor
        mostrarCampoValor();
    }

    // Funci칩n para confirmar asignaci칩n masiva
    function confirmarAsignacionMasiva() {
        const criterio = document.getElementById('criterio_masivo').value;
        const rol = document.getElementById('rol_masivo').value;
        const cantidad = document.getElementById('cantidad_limite').value;
        
        let mensaje = `쮺onfirma la asignaci칩n masiva?\n\n`;
        mensaje += `Criterio: ${criterio}\n`;
        mensaje += `Rol: ${rol}\n`;
        if (cantidad) {
            mensaje += `Cantidad l칤mite: ${cantidad} expedientes\n`;
        } else {
            mensaje += `Cantidad: Todos los expedientes que cumplan el criterio\n`;
        }
        mensaje += `\n丘멆잺 Esta operaci칩n no se puede deshacer f치cilmente.`;
        
        return confirm(mensaje);
    }

    // Funci칩n para mostrar/ocultar campo de valor seg칰n criterio
    function mostrarCampoValor() {
        const criterio = document.getElementById('criterio_masivo').value;
        const campoValor = document.getElementById('campo_valor_criterio');
        const inputTexto = document.getElementById('valor_criterio');
        const selectEstado = document.getElementById('valor_estado');
        const ayuda = document.getElementById('ayuda_criterio');
        
        // Ocultar todos los campos primero
        inputTexto.style.display = 'none';
        selectEstado.style.display = 'none';
        ayuda.style.display = 'none';
        
        // Limpiar valores
        inputTexto.value = '';
        selectEstado.value = '';
        
        // Deshabilitar ambos campos primero
        inputTexto.disabled = true;
        selectEstado.disabled = true;
        
        if (criterio === 'estado') {
            selectEstado.style.display = 'block';
            selectEstado.disabled = false;
            ayuda.style.display = 'block';
            ayuda.textContent = 'Selecciona el estado espec칤fico para filtrar expedientes';
        } else if (criterio === 'tipo_solicitud') {
            inputTexto.style.display = 'block';
            inputTexto.disabled = false;
            inputTexto.placeholder = 'Ej: TUTELA, AMPARO, etc.';
            ayuda.style.display = 'block';
            ayuda.textContent = 'Ingresa el tipo de solicitud (b칰squeda parcial)';
        } else if (criterio === 'juzgado_origen') {
            inputTexto.style.display = 'block';
            inputTexto.disabled = false;
            inputTexto.placeholder = 'Ej: JUZGADO CIVIL, PENAL, etc.';
            ayuda.style.display = 'block';
            ayuda.textContent = 'Ingresa el nombre del juzgado (b칰squeda parcial)';
        }
    }

    // Funci칩n para confirmar asignaci칩n masiva con validaci칩n mejorada
    function confirmarAsignacionMasiva() {
        const criterio = document.getElementById('criterio_masivo').value;
        const rol = document.getElementById('rol_masivo').value;
        const cantidad = document.getElementById('cantidad_limite').value;
        
        // Obtener el valor del criterio seg칰n el tipo
        let valorCriterio = '';
        if (criterio === 'estado') {
            const selectEstado = document.getElementById('valor_estado');
            valorCriterio = selectEstado.value;
            
            if (!valorCriterio) {
                alert('Debe seleccionar un estado espec칤fico');
                return false;
            }
        } else if (criterio === 'tipo_solicitud' || criterio === 'juzgado_origen') {
            const inputTexto = document.getElementById('valor_criterio');
            valorCriterio = inputTexto.value.trim();
            
            if (!valorCriterio) {
                alert('Debe ingresar un valor para el criterio seleccionado');
                return false;
            }
        }
        
        let mensaje = `쮺onfirma la asignaci칩n masiva?\n\n`;
        mensaje += `Criterio: ${criterio}\n`;
        if (valorCriterio) {
            mensaje += `Valor: ${valorCriterio}\n`;
        }
        mensaje += `Rol: ${rol}\n`;
        if (cantidad) {
            mensaje += `Cantidad l칤mite: ${cantidad} expedientes\n`;
        } else {
            mensaje += `Cantidad: Todos los expedientes que cumplan el criterio\n`;
        }
        mensaje += `\n丘멆잺 Esta operaci칩n no se puede deshacer f치cilmente.`;
        
        return confirm(mensaje);
    }

    // Inicializar el formulario cuando se carga la p치gina
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== DEPURACI칍N: P치gina cargada ===');
        
        // Asegurar que los campos est칠n ocultos al cargar
        mostrarCampoValor();
        
        // Agregar event listener al select de criterio
        const criterioSelect = document.getElementById('criterio_masivo');
        if (criterioSelect) {
            criterioSelect.addEventListener('change', mostrarCampoValor);
        }
        
        // 游댌 DEPURACI칍N: Verificar botones de "Ver todos"
        const botonesIngresos = document.querySelectorAll('button.btn-toggle-ingresos');
        const botonesEstados = document.querySelectorAll('button.btn-toggle-estados');
        
        console.log('Botones "Ver todos" de INGRESOS encontrados:', botonesIngresos.length);
        console.log('Botones "Ver todos" de ESTADOS encontrados:', botonesEstados.length);
        
        botonesIngresos.forEach((btn, index) => {
            console.log(`Bot칩n Ingresos ${index + 1}:`, btn);
        });
        
        botonesEstados.forEach((btn, index) => {
            console.log(`Bot칩n Estados ${index + 1}:`, btn);
        });
        
        // Verificar elementos de destino
        const ingresosAdicionales = document.getElementById('ingresos-adicionales');
        const estadosAdicionales = document.getElementById('estados-adicionales');
        
        console.log('Elemento #ingresos-adicionales:', ingresosAdicionales);
        console.log('Elemento #estados-adicionales:', estadosAdicionales);
        
        if (ingresosAdicionales) {
            console.log('  - Display inicial:', window.getComputedStyle(ingresosAdicionales).display);
            console.log('  - Clases:', ingresosAdicionales.className);
        }
        
        if (estadosAdicionales) {
            console.log('  - Display inicial:', window.getComputedStyle(estadosAdicionales).display);
            console.log('  - Clases:', estadosAdicionales.className);
        }
        
        // 游댢 SOLUCI칍N ALTERNATIVA: Agregar event listeners directamente
        console.log('=== Agregando event listeners directamente ===');
        
        botonesIngresos.forEach((btn, index) => {
            console.log(`Agregando listener a bot칩n Ingresos ${index + 1}`);
            btn.addEventListener('click', function(e) {
                console.log('游둼勇 CLICK DETECTADO en bot칩n de ingresos (via addEventListener)');
                e.preventDefault();
                e.stopPropagation();
                toggleIngresosAdicionales(this);
            });
        });
        
        botonesEstados.forEach((btn, index) => {
            console.log(`Agregando listener a bot칩n Estados ${index + 1}`);
            btn.addEventListener('click', function(e) {
                console.log('游둼勇 CLICK DETECTADO en bot칩n de estados (via addEventListener)');
                e.preventDefault();
                e.stopPropagation();
                toggleEstadosAdicionales(this);
            });
        });
        
        console.log('=== Event listeners agregados ===');
    });

    // Las funciones toggle se definen en `static/js/base.js` para evitar duplicados.
</script>

{% endblock %}